---
ID: "413"
post_author: "2"
post_date: "2013-05-30 14:25:31"
post_date_gmt: "2013-05-30 14:25:31"
post_title: OpenWRT web
post_excerpt: ""
post_status: publish
comment_status: open
ping_status: open
post_password: ""
post_name: openwrt-tips
to_ping: ""
pinged: ""
post_modified: "2013-05-30 14:25:31"
post_modified_gmt: "2013-05-30 14:25:31"
post_content_filtered: ""
post_parent: "0"
guid: http://s12.pw/wp/?p=413
menu_order: "0"
post_type: post
post_mime_type: ""
comment_count: "0"
title: OpenWRT web
...
---

<h1>uHTTPd</h1>

<h2>Embedded Lua</h2>

uHTTPd supports running Lua in-process, which can speed up Lua CGI scripts. It is unclear whether LuCI supports running in this embedded interpreter. LuCI seems to work fine (if not better) with the embedded Lua interpreter.

<pre><code>root@OpenWrt:~# opkg install uhttpd-mod-lua
Installing uhttpd-mod-lua (18) to root...
Downloading http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/uhttpd-mod-lua_18_ar71xx.ipk.
Configuring uhttpd-mod-lua.
root@OpenWrt:~# uci set uhttpd.main.lua_prefix=/lua
root@OpenWrt:~# uci set uhttpd.main.lua_handler=/root/test.lua
root@OpenWrt:~# cat /root/test.lua
function handle_request(env)
        uhttpd.send("HTTP/1.0 200 OKrn")
        uhttpd.send("Content-Type: text/plainrnrn")
        uhttpd.send("Hello world.n")
end
root@OpenWrt:~# /etc/init.d/uhttpd restart
root@OpenWrt:~# wget -qO- http://127.0.0.1/lua/
Hello world.
root@OpenWrt:~#
</code></pre>

Tested on Backfire 10.03.1 with uHTTPd 28.

<h2>HTTPS Enable and Certificate Settings and Creation</h2>

First of all, you need to install the <code>uhttpd-mod-tls</code> package in order to pull into the system the 'TLS plugin which adds HTTPS support to uHTTPd'.

Then if listen_https is defined in the server configuration, the certificate and private key is missing. In this case (as of 10.03.1) you'll need to install the <code>luci-ssl</code> meta-package which in turn will pull also the <code>px5g</code> script. With this utility the init script will generate the appropriate certifcate and key files when the server is started for the first time, either by reboot or by manual restart.

The <code>/etc/config/uhttpd</code> file contains in the end a section detailing the certificate and key files creation parameters:

<table>
<thead>
<tr>
  <th>Name</th>
  <th>Type</th>
  <th>Required</th>
  <th>Default</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td>days</td>
  <td>integer</td>
  <td>no</td>
  <td>730</td>
  <td>Validity time of the generated certificates in days</td>
</tr>
<tr>
  <td>bits</td>
  <td>integer</td>
  <td>no</td>
  <td>1024</td>
  <td>Size of the generated RSA key in bits</td>
</tr>
<tr>
  <td>country</td>
  <td>string</td>
  <td>no</td>
  <td>DE</td>
  <td>ISO country code of the certificate issuer</td>
</tr>
<tr>
  <td>state</td>
  <td>string</td>
  <td>no</td>
  <td>Berlin</td>
  <td>State of the certificate issuer</td>
</tr>
<tr>
  <td>location</td>
  <td>string</td>
  <td>no</td>
  <td>Berlin</td>
  <td>Location/city of the certificate issuer</td>
</tr>
<tr>
  <td>commonname</td>
  <td>string</td>
  <td>no</td>
  <td>OpenWrt</td>
  <td>Common name covered by the certificate</td>
</tr>
</tbody>
</table>

Those will be needed only once, at the next restart.

<h2>Basic Authentication (httpd.conf)</h2>

For backward compatibility reasons, uhttpd uses the old Busybox httpd config file /<code>etc/httpd.conf</code> to define authentication areas and the associated usernames and passwords. This configuration file is not in UCI format and usually shipped or generated by external packages like webif (X-Wrt).

Authentication realms are defined in the format <code>prefix:username:password</code> with one entry per line followed by a newline.

<ul>
<li>prefix is the URL part covered by the realm, e.g. /cgi-bin to request basic auth for any CGI program</li>
<li>username specifies the username a client has to login with</li>
<li>password defines the secret password required to authenticate</li>
</ul>

The password can be either in plain text format, MD5 encoded or in the form $p$user where user refers to an account in /etc/shadow or /etc/passwd.

A plain text password can be converted to MD5 encoding by using the -m switch of the uhttpd executable:

<pre><code>root@OpenWrt:~# uhttpd -m secret
$1$$ysVNzQc4CTMkp5daOdZ.3/
</code></pre>

<strong>Note that this creates a empty salt!</strong>

<h2>URL decoding</h2>

Like Busybox HTTPd, the URL decoding of strings on the command line is supported through the -d switch:

<pre><code>root@OpenWrt:/# uhttpd -d "An%20URL%20encoded%20String%21%0a"
An URL encoded String!
</code></pre>

If the $p$… format is used, uhttpd will compare the client provided password against the one stored in the shadow or passwd database.<br />
URL decoding<br />
Like Busybox HTTPd, the URL decoding of strings on the command line is supported through the -d switch:<br />
root@OpenWrt:/# uhttpd -d "An%20URL%20encoded%20String%21%0a"<br />
An URL encoded String!

