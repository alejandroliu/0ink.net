<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>Remote Bridging</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Sometimes we need to connect two or more geographically distrubuted ethernet networks to one broadcast domain. There can be two different office..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">0ink.net</a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">About</a></li>
                    <li><a href="/pages/privacy-policy.html">Privacy Policy</a></li>
                    <li class="active"><a href="/category/blog.html">Blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/remote-bridging.html" rel="bookmark"
           title="Permalink to Remote Bridging">Remote Bridging</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-05-27T00:00:00+02:00">
                Published: Mon 27 May 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>

</footer><!-- /.post-info -->      <p>Sometimes we need to connect two or more geographically distrubuted ethernet networks to one broadcast domain. There can be two different office networks of some company which uses smb protocol partially based on broadcast network messages. Another example of such situation is computer cafes: a couple of computer cafes can provide to users more convinient environment forr playing multiplayer computer games without dedicated servers. Both sample networks in this article need to have one *nix server for bridging. Our networks can be connected by any possible hardware that provides IP connection between them.</p>
<h1>Connecting Two Remote Local Networks With Transparent Bridging Technique</h1>
<h2>Short description</h2>
<p>In described configuration we are connecting two remote LANs to make them appearing as one network with 192.168.1.0/24 address space (however physically, presense of bridges in network configuration is not affecting IP protocol and is fully transparent for it, so you can freely select any address space). Both of the bridging servers has two network interfaces: one (as eth0 in our example) connested to the LAN, and second (eth1) is being used as transport to connect networks. When ethernet tunnel between gateways in both networks will be bringed up we will connect tunnel interfaces with appropriate LAN interfaces with bridge interfaces. Schematically this configuration can be following:</p>
<div class="highlight"><pre><span></span><code>          +-------+                       +-------+
          |  br0  |                       |  br0  |
          +-------+                       +-------+
           |     |                         |     |
Network 1  |     |                         |     |   Network 2
----------eth0  tap0---eth1........eth1---tap0  eth0---------------
</code></pre></div>

<h1>Setting Up Bridging Servers</h1>
<p><em>Notice: This article describes Debian GNU/Linux servers setup. If you are using another distribution, there can be some differences in network configuration and package management, but the main idea of described actions will be the same.</em> First of all, we need to check if tun and bridge modules is not included in current kernel. If they are not includen, we need to rebuild kernel with CONFIG_TUN and CONFIG_BRIDGE options. Next, we need to create tunnel device file for our tunnel:</p>
<div class="highlight"><pre><span></span><code># cd /dev
# ./MAKEDEV tun
# mkdir misc
# ln -s /dev/net /dev/misc/net
</code></pre></div>

<p><em>Notice: Last command is needed to make vtun work, because authors build for debian is looking for tunnel device driver at /dev/misc/net/tun.</em> To create ethernet tunnel between bridging servers we will use <strong>vtun</strong> software. When <code>vtun</code> will be installed, we will need to select one of the bridging servers as master and second server will be slave and appropriately change vtund-start.conf and vtund.conf file in /etc/ on buth servers. Complete config files for master is following.</p>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vtund</span><span class="o">-</span><span class="n">start</span><span class="o">.</span><span class="n">conf</span>
<span class="o">----</span><span class="n">cut</span><span class="o">-</span><span class="n">here</span><span class="o">------------------------------------</span>
<span class="o">--</span><span class="n">server</span><span class="o">--</span> <span class="mi">5000</span>
<span class="o">----</span><span class="n">cut</span><span class="o">-</span><span class="n">here</span><span class="o">------------------------------------</span>

<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vtund</span><span class="o">.</span><span class="n">conf</span>
<span class="o">----</span><span class="n">cut</span><span class="o">-</span><span class="n">here</span><span class="o">------------------------------------</span>
<span class="n">options</span> <span class="p">{</span>
    <span class="n">port</span> <span class="mi">5000</span><span class="p">;</span>            <span class="c1"># Listen on this port.</span>

    <span class="c1"># Syslog facility</span>
    <span class="n">syslog</span>        <span class="n">daemon</span><span class="p">;</span>

    <span class="c1"># Path to various programs</span>
    <span class="n">ifconfig</span>      <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ifconfig</span><span class="p">;</span>
    <span class="n">route</span>         <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">route</span><span class="p">;</span>
    <span class="n">firewall</span>      <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">iptables</span><span class="p">;</span>
    <span class="n">ip</span>            <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ip</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">default</span> <span class="p">{</span>
    <span class="n">compress</span> <span class="n">no</span><span class="p">;</span>
    <span class="n">encrypt</span> <span class="n">no</span><span class="p">;</span>
    <span class="n">speed</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">rembridge</span> <span class="p">{</span>
    <span class="n">passwd</span> <span class="n">Pa</span><span class="o">$$</span><span class="n">Wd</span><span class="p">;</span>
    <span class="n">type</span> <span class="n">ether</span><span class="p">;</span>
    <span class="n">proto</span> <span class="n">udp</span><span class="p">;</span>
    <span class="n">keepalive</span> <span class="n">yes</span><span class="p">;</span>
    <span class="n">compress</span> <span class="n">no</span><span class="p">;</span>
    <span class="n">encrypt</span> <span class="n">yes</span><span class="p">;</span>

    <span class="n">up</span> <span class="p">{</span>
        <span class="c1"># Connection is Up</span>
        <span class="n">ifconfig</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2"> up&quot;</span><span class="p">;</span>
        <span class="n">program</span> <span class="s2">&quot;brctl addif br0 </span><span class="si">%%</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="n">down</span> <span class="p">{</span>
        <span class="c1"># Connection is Down</span>
        <span class="n">ifconfig</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2"> down&quot;</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="o">----</span><span class="n">cut</span><span class="o">-</span><span class="n">here</span><span class="o">------------------------------------</span>
</code></pre></div>

<p>Slave server config files is following:</p>
<div class="highlight"><pre><span></span><code><span class="c">/etc/vtund</span><span class="nb">-</span><span class="c">start</span><span class="nt">.</span><span class="c">conf</span>
<span class="nb">----</span><span class="c">cut</span><span class="nb">-</span><span class="c">here</span><span class="nb">------------------------------------</span><span class="c"></span>
<span class="c">rembridge 10</span><span class="nt">.</span><span class="c">1</span><span class="nt">.</span><span class="c">1</span><span class="nt">.</span><span class="c">1 </span><span class="nb">-</span><span class="c">p</span>
<span class="nb">----</span><span class="c">cut</span><span class="nb">-</span><span class="c">here</span><span class="nb">------------------------------------</span><span class="c"></span>
</code></pre></div>

<p><em>Notice: In this example 10.1.1.1 is transport address of master server.</em></p>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vtund</span><span class="o">.</span><span class="n">conf</span>
<span class="o">----</span><span class="n">cut</span><span class="o">-</span><span class="n">here</span><span class="o">------------------------------------</span>
<span class="n">options</span> <span class="p">{</span>
  <span class="c1"># Path to various programs</span>
  <span class="n">ifconfig</span>      <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ifconfig</span><span class="p">;</span>
  <span class="n">route</span>         <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">route</span><span class="p">;</span>
  <span class="n">firewall</span>      <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">iptables</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">korsar</span> <span class="p">{</span>
  <span class="k">pass</span>  <span class="n">Pa</span><span class="o">$$</span><span class="n">Wd</span><span class="p">;</span>         <span class="c1"># Password</span>
  <span class="n">type</span>  <span class="n">ether</span><span class="p">;</span>          <span class="c1"># Ethernet tunnel</span>
  <span class="n">up</span> <span class="p">{</span>
        <span class="c1"># Connection is Up</span>
        <span class="n">ifconfig</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2"> up&quot;</span><span class="p">;</span>
        <span class="n">program</span> <span class="s2">&quot;brctl addif br0 </span><span class="si">%%</span><span class="s2">&quot;</span>
  <span class="p">};</span>
  <span class="n">down</span> <span class="p">{</span>
        <span class="c1"># Connection is Down</span>
        <span class="n">ifconfig</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2"> down&quot;</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="o">----</span><span class="n">cut</span><span class="o">-</span><span class="n">here</span><span class="o">------------------------------------</span>
</code></pre></div>

<p>To bring up bridge between LAN ethernet interface and our newly created tunnel interface we need to create bridge interface. To complete this task we will add br0 interface description to /etc/network/interfaces file:</p>
<div class="highlight"><pre><span></span><code>auto br0
iface br0 inet static
    address 192.168.1.199
    netmask 255.255.255.0
    bridge_ports eth0
</code></pre></div>

<p><em>Notice: IP-addresses on both sides of our bridge must be unique in both networks. eth0 is LAN interface.</em> Now, we need to bring this interface up:</p>
<div class="highlight"><pre><span></span><code># ifup br0
</code></pre></div>

<p>When br0 interface will be created, we will be able to start vtun. # /etc/init.d/vtund restart If everything was done correctly, we will see following results on both sersers (br0 and tap0 interfaces):</p>
<div class="highlight"><pre><span></span><code># ifconfig tap0
tap0  Link encap:Ethernet  HWaddr 00:FF:B2:91:CA:DE
      UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
      RX packets:701818 errors:0 dropped:0 overruns:0 frame:0
      TX packets:405939 errors:0 dropped:0 overruns:0 carrier:0
      collisions:0 txqueuelen:1000
      RX bytes:975889241 (930.6 MiB)  TX bytes:44704104 (42.6 MiB)

# ifconfig br0
br0   Link encap:Ethernet  HWaddr 00:02:44:2A:03:30
      inet addr:192.168.1.199  Bcast:192.168.1.255  Mask:255.255.255.0
      UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
      RX packets:2660 errors:0 dropped:0 overruns:0 frame:0
      TX packets:42 errors:0 dropped:0 overruns:0 carrier:0
      collisions:0 txqueuelen:0
      RX bytes:239368 (233.7 KiB)  TX bytes:2338 (2.2 KiB)

#
</code></pre></div>

<p>If we need to see current state of bridge interface, we can use brctl tool:</p>
<div class="highlight"><pre><span></span><code># <span class="nv">brctl</span> <span class="k">show</span> <span class="nv">br0</span>
<span class="nv">bridge</span> <span class="nv">name</span>     <span class="nv">bridge</span> <span class="nv">id</span>               <span class="nv">STP</span> <span class="nv">enabled</span>     <span class="nv">interfaces</span>
<span class="nv">br0</span>             <span class="mi">8000</span>.<span class="mi">0002442</span><span class="nv">a0330</span>       <span class="nv">no</span>              <span class="nv">eth0</span>
                                                        <span class="nv">tap0</span>
#
</code></pre></div>

<p>When all of described steps will be completed, our computers in both networks will be able to communicate with each other. IP addresses on bridge interfaces can be used for troubleshooting network connection. And last, if you need, you can turn on compression or enrtyption of data within created tunnel.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://www.iliu.net">Familia</a></li>
                            <li><a href="https://github.com/alejandroliu/0ink.net">github</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>