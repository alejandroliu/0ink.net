<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>Encrypting FileSystem in Void Linux</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="The point of this recipe is to create a encrypted file sytem so that when the disc is disposed, it does not need to be securely erased. This is..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">0ink.net</a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">About</a></li>
                    <li><a href="/pages/privacy-policy.html">Privacy Policy</a></li>
                    <li class="active"><a href="/category/blog.html">Blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/encrypting-filesystem-in-void-linux.html" rel="bookmark"
           title="Permalink to Encrypting FileSystem in Void Linux">Encrypting FileSystem in Void Linux</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-02-28T00:00:00+01:00">
                Published: Thu 28 February 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>

</footer><!-- /.post-info -->      <p>The point of this recipe is to create a encrypted file sytem
so that when the disc is disposed, it does not need to be
securely erased.  This is particularly important for SSD devices
since because of block remapping (for wear levelling) data can't
be overwritten consistently.</p>
<p>The idea is that the boot/root filesystem containing the encryption
keys are stored in a different device as the encrypted file system.</p>
<hr>
<p>Generate a passphrase and save it a safe place for later.</p>
<h1>Create block devices</h1>
<div class="highlight"><pre><span></span><code>xbps-install -S lvm2 cryptsetup
cryptsetup luksFormat /dev/xda2
cryptsetup luksOpen /dev/xda2 crypt-pool
vgcreate pool /dev/mapper/crypt-pool
lvcreate --name home0 -L 20G pool
</code></pre></div>

<p>Add <code>rd.luks.crypttab=1 rd.luks=1</code> to the kernel command line.</p>
<h1>Create a decryption key</h1>
<p>Create the key file in the unencrypted <code>/</code> partition</p>
<div class="highlight"><pre><span></span><code><span class="nv">dd</span> <span class="k">if</span><span class="o">=/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">urandom</span> <span class="nv">of</span><span class="o">=/</span><span class="nv">crypto_keyfile</span>.<span class="nv">bin</span> <span class="nv">bs</span><span class="o">=</span><span class="mi">1024</span> <span class="nv">count</span><span class="o">=</span><span class="mi">4</span>
<span class="nv">chmod</span> <span class="mi">000</span> <span class="o">/</span><span class="nv">crypto_keyfile</span>.<span class="nv">bin</span>
<span class="nv">cryptsetup</span> <span class="o">-</span><span class="nv">v</span> <span class="nv">luksAddKey</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">xda2</span> <span class="o">/</span><span class="nv">crypto_keyfile</span>.<span class="nv">bin</span>
</code></pre></div>

<p>Look up the UUID</p>
<div class="highlight"><pre><span></span><code>blkid /dev/xda2
</code></pre></div>

<p>Create entry in <code>/etc/crypttab</code>:</p>
<div class="highlight"><pre><span></span><code>crypt-pool  UUID=xxxxxxxxxxxxxxxx /crypto_keyfile.bin luks
</code></pre></div>

<p>Create <code>/etc/dracut.conf.d/10-crypt.conf</code></p>
<div class="highlight"><pre><span></span><code>install_items+=&quot;/etc/crypttab /crypto_keyfile.bin&quot;
</code></pre></div>

<p>Update initrd:</p>
<div class="highlight"><pre><span></span><code>xbps-reconfigure -f linux4.19
</code></pre></div>

<p>Update boot menu entries:</p>
<div class="highlight"><pre><span></span><code>bash /boot/mkmenu.sh
</code></pre></div>

<p>At this point it would be good to save:</p>
<ul>
<li><code>/etc/crypttab</code></li>
<li><code>/crypto_keyfile.bin</code></li>
<li>Optionally, passphrase</li>
</ul>
<hr>
<p>Reboot and make sure that the block device gets created on start-up.</p>
<p>Create your file-system and add it to <code>/etc/fstab</code>.</p>
<h1>Re-using an existing fs in a new OS install</h1>
<p>Usually this procedure would be used on a fresh install when the
root filesystem was destroyed.  It requires to have a backup of the
<code>/crypto_keyfile.bin</code> and optionally the <code>/etc/crypttab</code>.</p>
<ol>
<li>Add <code>rd.luks.crypttab=1 rd.luks=1</code> to the kernel command line.</li>
<li>Restore the <code>/crypto_keyfile.bin</code>.  Make sure it is in <code>/</code> and
   permissions are <code>chmod 000 /crypto_keyfile.bin</code>.</li>
<li>If available, restore the <code>/etc/crypttab</code> otherwise look up the
   block device UUID and re-create the <code>/etc/crypttab</code> entry:</li>
<li>Look-up the UUID:</li>
<li><code>blkid /dev/xda2</code></li>
<li>Add the entry in <code>/etc/crypttab</code></li>
<li><code>crypt-pool    UUID=xxxxxxxxxxxxxxxx /crypto_keyfile.bin luks</code></li>
<li>Create <code>/etc/dracut.conf.d/10-crypt.conf</code></li>
<li><code>install_items+="/etc/crypttab /crypto_keyfile.bin"</code></li>
<li>Update initrd:</li>
<li><code>xbps-reconfigure -f linux4.19</code></li>
<li>Update boot menu entries:</li>
<li><code>bash /boot/mkmenu.sh</code></li>
</ol>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://www.iliu.net">Familia</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://github.com/alejandroliu/0ink.net">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>