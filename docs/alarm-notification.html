<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>Alarm Notification</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="This tutorial describes how to use the alarm manager to set alarms and how to use the notification framework to display them. In short, the..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">0ink.net</a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">About</a></li>
                    <li><a href="/pages/privacy-policy.html">Privacy Policy</a></li>
                    <li class="active"><a href="/category/blog.html">Blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/alarm-notification.html" rel="bookmark"
           title="Permalink to Alarm Notification">Alarm Notification</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-09-19T00:00:00+02:00">
                Published: Thu 19 September 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>

</footer><!-- /.post-info -->      <p>This tutorial describes how to use the alarm manager to set alarms and how to use the notification framework to display them. In short, the sequence goes like this:</p>
<ol>
<li>In an Activity AlarmManager.set is called with a PendingIntent containing a Uri.</li>
<li>When the alarm goes off, the Uri is called triggering a BroadcastReceiver.</li>
<li>In the BroadcastReceiver NotificationManager.notify is called with a PendingIntent.</li>
<li>When the notification is clicked, the Activity in the PendingIntent is started.</li>
</ol>
<h1>Alarm Manager</h1>
<p>The Alarm Manager is a SystemService so it should be gotten like this</p>
<div class="highlight"><pre><span></span><code>AlarmManager am = (AlarmManager) getSystemService(Context.ALARM_SERVICE);
</code></pre></div>

<p>It's set method can take parameters to define when, how and what to set off for the alarm. To set an absolute time and have it go off even if the device is on stand-by, use the <code>RTC_WAKEUP</code> type. The PendingIntent parameter is what gets called when the alarm goes off. Unless you want an Activity to start when the alarm goes off, a broadcast-type intent should be used like this</p>
<div class="highlight"><pre><span></span><code>PendingIntent pendingintent = PendingIntent.getBroadcast(Activity.this, 0, intent, Intent.FLAG_GRANT_READ_URI_PERMISSION);
</code></pre></div>

<p>The intent parameter can hold a Uri which can contain some information about what the alarm is all about.</p>
<h1>BroadcastReceiver and NotificationManager</h1>
<p>The BroadcastReceiver must be defined in the manifest.xml like this</p>
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;receiver</span>
        <span class="na">android:name=</span><span class="s">&quot;package.AlarmReceiver&quot;</span>
    <span class="nt">&gt;</span>
        <span class="nt">&lt;intent-filter&gt;</span>
            <span class="nt">&lt;action</span>
                <span class="na">android:name=</span><span class="s">&quot;intentname&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;data</span>
                <span class="na">android:scheme=</span><span class="s">&quot;myscheme&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/intent-filter&gt;</span>
    <span class="nt">&lt;/receiver&gt;</span>
</code></pre></div>

<p>The intentname and myscheme values must match the name used in the intent and the scheme used in the uri in the intent. In the onReceive method, the notification is started to show the user the alarm went off. The Notification Manager is also a SystemService, get it like this</p>
<div class="highlight"><pre><span></span><code>NotificationManager nm = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
</code></pre></div>

<p>Create a new Notification object with an icon, a title and the time (probably <code>System.currentTimeMillis()</code>) Set some flags into the defaults like this</p>
<div class="highlight"><pre><span></span><code>notification.defaults |= Notification.DEFAULT_SOUND;
notification.defaults |= Notification.DEFAULT_VIBRATE;
</code></pre></div>

<p>Use the <code>setLatestEventInfo</code> method to set another PendingIntent into the notification. The Activity in this intent will be called when the user clicks the notification. Again you can include a Uri into the intent to pass data to the Activity about which notification was clicked. Finally, be sure to use a unique id when calling the Notification managers notify method to actually fire the notification.</p>
<h1>Activity</h1>
<p>When the user has clicked the notification is it probably safe to remove it. In the Activity which gets called by the notification, a call to the NotificationManagers cancel can be used to do this. The id which was used to fire the notification in the BroadcastReceiver will let the system know which notification to remove.</p>
<h1>Reloading</h1>
<p>Android's Alarm Manager does not remember alarms when the device reboots. In order to restore the alarms you need to take these steps:</p>
<ol>
<li>In the Activity which sets the alarms, also save information about each alarm into a database.</li>
<li>Create an additional BroadcastReceiver which gets called at boot-up to re-install the alarms.</li>
</ol>
<p>Add the <code>android.permission.RECEIVE_BOOT_COMPLETED</code> uses-permission and the following receiver to the manifest.xml</p>
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;receiver</span>
        <span class="na">android:name=</span><span class="s">&quot;package.AlarmSetter&quot;</span>
    <span class="nt">&gt;</span>
        <span class="nt">&lt;intent-filter&gt;</span>
            <span class="nt">&lt;action</span>
                <span class="na">android:name=</span><span class="s">&quot;android.intent.action.BOOT_COMPLETED&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/intent-filter&gt;</span>
    <span class="nt">&lt;/receiver&gt;</span>
</code></pre></div>

<p>In the onReceive method, read the database and re-install the alarms in the same way as was done at the top.</p>
<h1>Proximity Alerts</h1>
<p>A similar mechanism can be used for proximity alerts. The LocationManager will fire an alert which is nearly identical to an alarm. The same mechanism to restore alerts can be used after rebooting the device.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://www.iliu.net">Familia</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://github.com/alejandroliu/0ink.net">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>