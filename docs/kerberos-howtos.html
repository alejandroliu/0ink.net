<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>Kerberos howtos</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Kerberos is a network authentication protocol which works on the basis of "tickets" to allow nodes communicating over a non-secure network to..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">0ink.net</a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">About</a></li>
                    <li><a href="/pages/privacy-policy.html">Privacy Policy</a></li>
                    <li class="active"><a href="/category/blog.html">Blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/kerberos-howtos.html" rel="bookmark"
           title="Permalink to Kerberos howtos">Kerberos howtos</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-05-27T00:00:00+02:00">
                Published: Mon 27 May 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>

</footer><!-- /.post-info -->      <p>Kerberos is a network authentication protocol which works on the basis
of "tickets" to allow nodes communicating over a non-secure network to
prove their identity to one another in a secure manner. (Source
<a href="http://en.wikipedia.org/wiki/Kerberos_(protocol)">Kerberos_(protocol)</a> )</p>
<h1>Backups</h1>
<p>Create backup:</p>
<div class="highlight"><pre><span></span><code>kdb5_util dump _dump_file_
</code></pre></div>

<p>Restore from dump file:</p>
<div class="highlight"><pre><span></span><code><span class="n">kdb5_util</span> <span class="nb">load</span> <span class="n">_dump_file_</span>
</code></pre></div>

<h1>Master/Slave replication</h1>
<p>Initial set-up:</p>
<div class="highlight"><pre><span></span><code>(master)# kdb5_util dump _dump_file_
(master)# kprop -d -f _dump_file_ _slave_
</code></pre></div>

<p>In <code>crontab</code> on master:</p>
<div class="highlight"><pre><span></span><code>krb5_util dump _dump_file_
kprop -f _dump_file_ _slave_
</code></pre></div>

<h1>kadmin command</h1>
<p>From command line:</p>
<div class="highlight"><pre><span></span><code>kadmin.local -q &#39;cmd&#39;
</code></pre></div>

<ul>
<li>listprincs - list principals</li>
<li>ank <em>principal</em> - new principal (input: password)</li>
<li>delprinc <em>principal</em> - delete principal (input: yes/no)</li>
<li>ank -randkey host/<em>fqdn</em>@REALM - create a service key</li>
<li>ktadd -k <em>filename</em> host/<em>fqdn</em>@REALM export key to keytab file.</li>
</ul>
<p>Save keytab in <code>/etc/krb5.keytab</code> and</p>
<div class="highlight"><pre><span></span><code>chown root:root /etc/krb5.keytab
chmod 400 /etc/krb5.keytab
</code></pre></div>

<h1>Logging</h1>
<p>To turn logging on, add this section to <code>/etc/krb5.conf</code> (adapt the
file paths to your likings):</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="o">[</span><span class="n">logging</span><span class="o">]</span><span class="w"></span>
<span class="w">     </span><span class="k">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">FILE</span><span class="err">:</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="nf">log</span><span class="o">/</span><span class="n">krb5</span><span class="p">.</span><span class="nf">log</span><span class="w"></span>
<span class="w">     </span><span class="n">kdc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">FILE</span><span class="err">:</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="nf">log</span><span class="o">/</span><span class="n">krb5kdc</span><span class="p">.</span><span class="nf">log</span><span class="w"></span>
<span class="w">     </span><span class="n">admin_server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">FILE</span><span class="err">:</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="nf">log</span><span class="o">/</span><span class="n">kadmind</span><span class="p">.</span><span class="nf">log</span><span class="w"></span>
</code></pre></div>

<h1>Merging (or editing) a keytab file</h1>
<p>Merging or editing keytabs is done through the <strong>ktutil</strong> command.
Suppose we have two keytabs, keytab1 and keytab2, each having their own
set of keys, and we would like to merge the two keytabs in one (or
create a new keytab containing specific keys). The operation is done
through the <strong>ktutil</strong> shell, with <strong>rkt</strong> and <strong>write_kt</strong> commands,
and optionally <strong>delent</strong> if you want to delete some entities. Example:</p>
<div class="highlight"><pre><span></span><code> # ktutil
</code></pre></div>

<p>Read content of keytab1:</p>
<div class="highlight"><pre><span></span><code><span class="c"> ktutil: rkt keytab1</span>
<span class="c"> ktutil: list</span>
<span class="c"> slot KVNO Principal</span>
<span class="c"> </span><span class="nb">----</span><span class="c"> </span><span class="nb">----</span><span class="c"> </span><span class="nb">-------------------------------------------------------------</span><span class="c"></span>
<span class="c"> 1 3 </span><span class="nv">&lt;</span><span class="c">principal and key of keytab1</span><span class="nv">&gt;</span><span class="c"></span>
<span class="c"> 2 3 </span><span class="nv">&lt;</span><span class="c">principal and key of keytab1</span><span class="nv">&gt;</span><span class="c"></span>
</code></pre></div>

<p>Now, we will read the content of keytab2:</p>
<div class="highlight"><pre><span></span><code> ktutil: rkt keytab2
 ktutil: list
 slot KVNO Principal
 ---- ---- -----------------------------------------------------------
 1 3 &lt;principal and key of keytab1&gt;
 2 3 &lt;principal and key of keytab1&gt;
 3 2 &lt;principal and key of keytab2&gt;
 4 2 &lt;principal and key of keytab2&gt;
</code></pre></div>

<p>Save this content in a temporary keytab:</p>
<div class="highlight"><pre><span></span><code> ktutil: write_kt /tmp/krb5.keytab
</code></pre></div>

<p>This utility is used to duplicate and tweak keytab entries (as its
name implies), and remove the need of exporting the keys out of the KDC
twice or more (simultaneously avoiding KVNO's increment).</p>
<h1>OpenWRT recipes</h1>
<h2>Packages</h2>
<h3>Server</h3>
<ul>
<li><code>krb5-server</code><ul>
<li><code>krb5-libs</code> (dependency of <strong>krb5-server</strong>)</li>
</ul>
</li>
</ul>
<h3>Client</h3>
<ul>
<li><code>krb5-client</code></li>
</ul>
<h2>Configuration</h2>
<p>Create the file <code>/etc/krb5.conf</code> with the following credentials. Example:</p>
<div class="highlight"><pre><span></span><code><span class="k">[libdefaults]</span>
    <span class="na">default_realm</span> <span class="o">=</span> <span class="s">YOURDOMAIN.ORG</span>
    <span class="na">dns_lookup_realm</span> <span class="o">=</span> <span class="s">false</span>
    <span class="na">dns_lookup_kdc</span> <span class="o">=</span> <span class="s">false</span>
    <span class="na">ticket_lifetime</span> <span class="o">=</span> <span class="s">24h</span>
    <span class="na">forwardable</span> <span class="o">=</span> <span class="s">yes</span>

<span class="k">[realms]</span>
    <span class="na">YOURDOMAIN.ORG</span> <span class="o">=</span> <span class="s">{</span>
        <span class="na">kdc</span> <span class="o">=</span> <span class="s">server_address_of_this_machine:88</span>
        <span class="na">admin_server</span> <span class="o">=</span> <span class="s">server_address_of_this_machine:749</span>
        <span class="na">default_domain</span> <span class="o">=</span> <span class="s">yourdomain.org</span>
    <span class="na">}</span>

<span class="k">[domain_realm]</span>
    <span class="na">.yourdomain.org</span> <span class="o">=</span> <span class="s">YOURDOMAIN.ORG</span>
    <span class="na">yourdomain.org</span> <span class="o">=</span> <span class="s">YOURDOMAIN.ORG</span>
</code></pre></div>

<p>Replace <code>YOURDOMAIN.ORG</code> / <code>yourdomain.org</code> with the domain name of
your domain the server should act for (names must be specified in
UPPER- / lowercase as shown above). Replace <code>server_address_of_this_machine</code>
with the host name/IP adress of this server you're setting up.</p>
<h3>Starting the server</h3>
<p>Start the server by issuing</p>
<div class="highlight"><pre><span></span><code>/etc/init.d/krb5kdc start
</code></pre></div>

<p>This should create the <code>/etc/krb5kdc/</code> directory with the following files</p>
<div class="highlight"><pre><span></span><code>-rw-------    1 root     root         8192 Feb 13 11:17 principal
-rw-------    1 root     root         8192 Feb 13 09:12 principal.kadm5
-rw-------    1 root     root            0 Feb 13 09:12 principal.kadm5.lock
-rw-------    1 root     root            0 Feb 13 11:17 principal.ok
</code></pre></div>

<p>In case you don't get any error messages check your server by logging
on with <code>kadmin.local</code> In case everything works well you will see the
following message</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@bridge</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">kadmin</span><span class="p">.</span><span class="k">local</span><span class="w"></span>
<span class="n">Authenticating</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">principal</span><span class="w"> </span><span class="n">xxxxxxx</span><span class="o">/</span><span class="k">admin</span><span class="nv">@YOURDOMAIN</span><span class="p">.</span><span class="n">ORG</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">password</span><span class="p">.</span><span class="w"></span>
<span class="n">kadmin</span><span class="p">.</span><span class="k">local</span><span class="err">:</span><span class="w"></span>
</code></pre></div>

<h3>Start on boot</h3>
<p>To enable/disable automatic start on boot:</p>
<div class="highlight"><pre><span></span><code>/etc/init.d/krb5kdc enable
</code></pre></div>

<p>this simply creates a symlink: <code>/etc/rc.d/S60krb5kdc</code> ? <code>/etc/init.d/krb5kdc</code></p>
<div class="highlight"><pre><span></span><code>/etc/init.d/krb5kdc disable
</code></pre></div>

<p>this removes the symlink again</p>
<h1>References</h1>
<p>See Also:</p>
<ul>
<li><a href="http://www.kerberos.org/software/adminkerberos.pdf">http://www.kerberos.org/software/adminkerberos.pdf</a><br>
    Refer to pages 16/17 for testing procedures.</li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://www.iliu.net">Familia</a></li>
                            <li><a href="https://github.com/alejandroliu/0ink.net">github</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>