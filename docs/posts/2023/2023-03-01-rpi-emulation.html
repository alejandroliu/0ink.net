<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>Raspberry Pi emulation with Qemu - 0ink.net</title>
	<meta name="author" content="Alejandro Liu">


	<meta name="description" content="raspberry, storage The idea here is that we use a Desktop PC for developing/debugging Raspberry Pi set-ups using qemu for emulating Rasperrby Pi. qemu currently supports the following configurations: Raspberry Pi Zero and 1A+ (armhf) Raspberry Pi 2B (armv7) Raspberry Pi 3A+ (aarch64) Raspberry Pi 3B (aarch64) This is …">
	<meta name="int-title" content="Raspberry Pi emulation with Qemu">
	<meta name="tags" content="boot, configuration, desktop, idea, linux, login, mouse, network, partition, raspberry, storage">
	<meta name="date" content="2023-04-21 00:00:00+02:00">
	<meta name="modified" content="2023-06-03 12:52:32.504730+02:00">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="/theme/css/main.css" type="text/css" />


    <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="0ink.net Atom Feed" />
    <link href="/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="0ink.net RSS Feed" />
</head>

<body>
    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	        <a href="/feeds/atom.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="atom feed" title="atom feed"/></a>
	    </div>
		<nav class="pages">
			    <a href="/pages/about.html">About</a>
-			    <a href="/pages/privacy-policy.html">Privacy Policy</a>
		</nav>
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		0ink.net</a>
	      <div class="logo">
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		  <img src="/images/2021/0ink.png" width="44" height="44" />
		</a>
	      </div>



      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
			<iframe src="https://duckduckgo.com/search.html?site=0ink.net&prefill=Search with DuckDuckGo" style="overflow:hidden;margin:5px;padding:0;width:408px;height:40px;" frameborder="0"></iframe>

	<article class="full">

		<h1>Raspberry Pi emulation with Qemu</h1>

<div class="metadata">
  <time datetime="2023-04-21T00:00:00+02:00" pubdate>Fri 21 April 2023</time>
    <address class="vcard author">
      by <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
    </address>
  <p>Updated: 2023-06-03 12:52:32.504730+02:00</p>
  in <a href="/category/c2023.html">2023</a>
<p class="tags">tagged <a href="/tag/boot.html">boot</a>, <a href="/tag/configuration.html">configuration</a>, <a href="/tag/desktop.html">desktop</a>, <a href="/tag/idea.html">idea</a>, <a href="/tag/linux.html">linux</a>, <a href="/tag/login.html">login</a>, <a href="/tag/mouse.html">mouse</a>, <a href="/tag/network.html">network</a>, <a href="/tag/partition.html">partition</a>, <a href="/tag/raspberry.html">raspberry</a>, <a href="/tag/storage.html">storage</a></p></div>
		<h3 id="raspberry-storage">raspberry, storage</h3>
<p>The idea here is that we use a Desktop PC for developing/debugging
Raspberry Pi set-ups using <a href="https://www.qemu.org/">qemu</a> for emulating Rasperrby Pi.</p>
<p><a href="https://www.qemu.org/">qemu</a> currently supports the following configurations:</p>
<ul>
<li>Raspberry Pi Zero and 1A+ (armhf)</li>
<li>Raspberry Pi 2B (armv7)</li>
<li>Raspberry Pi 3A+ (aarch64)</li>
<li>Raspberry Pi 3B (aarch64)<ul>
<li>This is the version I am targetting in this article.  I already recycled all
  my older boards.</li>
<li>Actually I tried emulating the other configurations but they did not work.
  Either they failed to boot, or the graphic display wouldn't work.</li>
<li>So <code>raspi3b</code> with 64-bit run-time is the only configuration I was able
  to succesfully boot.</li>
</ul>
</li>
<li><strong>NOTE that Raspberry Pi 4 is not supported at the moment.</strong></li>
</ul>
<p>So, unfortunately the state of things is far from perfect.</p>
<h2 id="missing-display-bug">Missing display bug</h2>
<p>During my tests on the <code>raspi3b</code> configuration, I was not able to get a working
console.  This has to do with this
<a href="https://github.com/raspberrypi/linux/commit/6513403f73e9bdf842597d10cb0b4775ae74d165">commit</a>,
which disables the Frame Buffer driver because <a href="https://www.qemu.org/">qemu</a> doesn't seem to
report the display properly.  This causes the error to show up on the kernel log:</p>
<div class="highlight"><pre><span></span><code>bcm2708_fb soc:fb: Unable to determine number of FBs. Disabling driver.
</code></pre></div>

<p>Before the commit, the kernel would assume that there was always <strong>one</strong> display.
On the other hand, this only affects use-cases that require display.  For headless
development, using the serial port works just fine.</p>
<p>For <a href="https://alpinelinux.org/">Alpine Linux</a>, the last working Frame Buffer version seems to be
<code>3.16.3-aarch64</code>.  The display did not work for <code>3.17.0-aarch64</code>.  The 32 bit
<code>3.16.3</code> would display the <code>Disabling driver.</code> message but I wasn't able to
boot further than that.</p>
<h2 id="emulated-hardware">Emulated hardware</h2>
<p>According to the <a href="https://www.qemu.org/docs/master/system/arm/raspi.html">qemu documentation</a>, the following is impleted:</p>
<ul>
<li>ARM1176JZF-S, Cortex-A7 or Cortex-A53 CPU.  I only tested the Cortex-A53 CPU
  for the <code>raspi3b</code> configuration.</li>
<li>Interrupt controller</li>
<li>DMA controller</li>
<li>Clock and reset controller (CPRMAN)</li>
<li>System Timer</li>
<li>GPIO controller</li>
<li>Serial ports (BCM2835 AUX - 16550 based - and PL011)</li>
<li>Random Number Generator (RNG)</li>
<li>Frame Buffer : However the Linux kernel does not seem to find it.</li>
<li>USB host (USBH)</li>
<li>GPIO controller</li>
<li>SD/MMC host controller</li>
<li>SoC thermal sensor</li>
<li>USB2 host controller (DWC2 and MPHI)</li>
<li>MailBox controller (MBOX)</li>
<li>VideoCore firmware (property)</li>
</ul>
<p>As you can see, no network interface is implemented, so you must use a USB network.</p>
<h2 id="getting-started">Getting started</h2>
<p>The basic command line I am using is:</p>
<div class="highlight"><pre><span></span><code>  qemu-system-aarch64 \
     -machine raspi3b -cpu cortex-a53 -m 1G -smp 4 -dtb bcm2710-rpi-3-b-plus.dtb \
     -kernel $linux_kernel -initrd $linux_initrd -append &quot;$cmdline&quot; \
     -sd $sd_image \
     -serial stdio \
     -usb \
     -device usb-mouse -device usb-kbd \
     -device usb-net,netdev=net0 -netdev user,id=net0,hostfwd=tcp::5555-:22
</code></pre></div>

<p>Command explanation:</p>
<ul>
<li><code>qemu-system-aarch64</code> : emulate a 64-bit ARM system</li>
<li><code>-machine raspi3b -cpu cortex-a53 -m 1G -smp 4 -dtb bcm2710-rpi-3-b-plus.dtb</code> :
  Matches the Raspberry Pi model 3B configuration.  The <code>dtb</code> is a file from the
  Raspberry Pi boot partition that is normally loaded by the Firmware.</li>
<li><code>-kernel $linux_kernel -initrd $linux_initrd -append "$cmdline"</code> : 
  Linux related boot configuration.  You must provide a kernel and optional initrd
  files.  Usually you would extract them from your <code>sdcard</code> image.  The append
  is used for the kernel command line.  If you want a serial console make sure
  you include:<ul>
<li><code>console=ttyAMA0,115200</code></li>
</ul>
</li>
<li><code>sd $sd_image</code> : Image for the <code>sdcard</code> storage</li>
<li><code>-usb</code> : Enable USB bus.  Needed for the emulated console mouse/keyboard and usb
  network.</li>
<li><code>-serial stdio</code> : enable a serial console (if you are using the emulated
  framebuffer.  Note that <code>Ctrl+C</code> are not caught and would kill the emulation.</li>
<li><code>-device usb-mouse -device usb-kbd</code> : these are used with the virtual framebuffer
  for providing keyboard and mouse.</li>
<li><code>-device usb-net,netdev=net0 -netdev user,id=net0,hostfwd=tcp::5555-:22</code> :
  Enable virtual networking using <a href="https://en.wikipedia.org/wiki/Slirp">slirp</a>.  </li>
</ul>
<p>If you wish to run a headless (only serial console) configuration, you should
remove the <code>-serial stdio -device usb-mouse -device usb-kbd</code> options and
just use:</p>
<ul>
<li><code>-nographic</code></li>
</ul>
<p>This would automatically enable <code>-serial stdio</code> and remove the framebuffer.  In
this configuration <code>Ctrl-C</code> is handled properly.</p>
<h2 id="tested-os">Tested OS</h2>
<p>I tested the following images, with these results:</p>
<table>
<thead>
<tr>
<th>Operating System</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://downloads.raspberrypi.org/raspios_lite_arm64/images/raspios_lite_arm64-2020-08-24/">2020-08-20-raspios-buster-arm64-lite.zip</a></td>
<td>fully working</td>
</tr>
<tr>
<td><a href="https://downloads.raspberrypi.org/raspios_lite_arm64/images/raspios_lite_arm64-2022-09-26/">2022-09-22-raspios-bullseye-arm64-lite.img.xz</a></td>
<td>Only works <em>headless</em>.  Default user is not set properly, so the image needs to be modified to inject login credentials</td>
</tr>
<tr>
<td><a href="https://dl-cdn.alpinelinux.org/alpine/v3.16/releases/aarch64/">alpine-rpi-3.16.3-aarch64.tar.gz</a></td>
<td>fully working</td>
</tr>
<tr>
<td><a href="https://dl-cdn.alpinelinux.org/alpine/v3.17/releases/aarch64/">alpine-rpi-3.17.0-aarch64.tar.gz</a></td>
<td>Only works <em>headless</em></td>
</tr>
</tbody>
</table>
<h2 id="raspi-emu">raspi-emu</h2>
<p>For convenicne, I wrote the <code>raspi-emu</code> script:</p>
<ul>
<li><a href="https://github.com/alejandroliu/0ink.net/tree/master/snippets/raspi-emu">rasi-emu</a></li>
</ul>
<p>This can be used to prepare images and run emulation sessions.</p>
<p>Usage:</p>
<h3 id="preparing-base-image">Preparing base image</h3>
<div class="highlight"><pre><span></span><code><span class="n">raspi</span><span class="o">-</span><span class="n">emu</span><span class="w"> </span><span class="n">prep</span><span class="w"> </span><span class="o">[</span><span class="n">options</span><span class="o">]</span><span class="w"> </span><span class="n">src</span>
</code></pre></div>

<p>Prepares the downloaded image so it can be used as a base for a <a href="https://www.qemu.org/">qemu</a> thin-provisioned
image.</p>
<p>Options:</p>
<ul>
<li><code>--sz=size</code> : Set the base image to the given <code>size</code>.</li>
<li><code>-c</code> | <code>--compress</code> : For <code>qcow2</code> images, create a compressed image.</li>
<li><code>--qcow2</code> : Create a <code>qcow2</code> format image.  This is the default.</li>
<li><code>--raw</code> : Create a <code>raw</code> image.</li>
<li><code>--volume=name</code> : When creating <a href="https://alpinelinux.org/">AlpineLinux</a> images, use <code>name</code> as the
  volume name.  Otherwise a random name is generated.</li>
</ul>
<h3 id="formatting-sdcard-image">Formatting SDCARD image</h3>
<div class="highlight"><pre><span></span><code><span class="n">raspi</span><span class="o">-</span><span class="n">emu</span><span class="w"> </span><span class="nf">format</span><span class="w"> </span><span class="o">[</span><span class="n">options</span><span class="o">]</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">dest</span>
</code></pre></div>

<p>Create an SDCARD image to be used for <a href="https://www.qemu.org/">qemu</a> emulation.  It will
create a thin-provisioned image when possible.</p>
<p>Options:</p>
<ul>
<li><code>--resize=size</code> : Set the SDCARD image to the given size.</li>
</ul>
<h3 id="running-emulation">Running Emulation</h3>
<div class="highlight"><pre><span></span><code><span class="n">raspi</span><span class="o">-</span><span class="n">emu</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">[</span><span class="n">options</span><span class="o">]</span><span class="w"> </span><span class="n">sdimg</span>
</code></pre></div>

<p>Will boot <a href="https://www.qemu.org/">qemu</a> emulation with the specified SDCARD image.  Configuration
when possible is read from the boot partition of the SDCARD.</p>
<p>Options:</p>
<ul>
<li><code>--vfb-only</code> : Enable the virtual framebuffer and disables the serial console.</li>
<li><code>--vfb</code> :  Enables the virtual framebuffer.  The serial console is kept enabled.</li>
<li><code>--no-vfb</code> : Disables virtual framebuffer.  This is the default.</li>
<li><code>--ttycon</code> : Enables the serial console for Linux logins.  (Default)</li>
<li><code>--no-ttycon</code> : Disables the serial console for Linux logins.</li>
<li><code>--vnet</code> : Enable virtual network.  (Default)</li>
<li><code>--no-vnet</code> : Disables hte virtual network.</li>
<li><code>--portfwd</code> : Enables virtual network.  Forwards port 5555 on host to port 22 on VM.</li>
<li><code>--portfwd=rule</code> : Adds the given port forwarding rule. \
     Example rule: <code>tcp::5555-:22</code></li>
<li><code>--no-portfwd</code> : Dsiables port forwarding.  (Default)</li>
<li><code>--raspi3b</code> : Emulate a Raspberry Pi Model 3B.  (Default)</li>
</ul>
<p>The default is running headless (only serial console) with networking enabled.</p>

	</article>


		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Years</h2>
	          <ul>
	              <li class="active"><a href="/category/c2023.html">2023</a></li>
	              <li ><a href="/category/c2022.html">2022</a></li>
	              <li ><a href="/category/c2021.html">2021</a></li>
	              <li ><a href="/category/c2020.html">2020</a></li>
	              <li ><a href="/category/c2019.html">2019</a></li>
	              <li ><a href="/category/c2018.html">2018</a></li>
	              <li ><a href="/category/c2017.html">2017</a></li>
	              <li ><a href="/category/c2016.html">2016</a></li>
	              <li ><a href="/category/c2015.html">2015</a></li>
	              <li ><a href="/category/c2014.html">2014</a></li>
	              <li ><a href="/category/c2013.html">2013</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="https://github.com/alejandroliu/">github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/alejandro-liu-ly/">LinkedIn</a><i></i></li>
			    </ul>
			  </aside>

	          <aside>
	            <h2>Links</h2>
	            <ul>
	                <li><a href="/sitemap.html">sitemap</a></li>
	                <li><a href="/tags.html">Tags</a></li>
	                <li><a href="https://github.com/alejandroliu/0ink.net">Repo</a></li>
	                <li><a href="https://home.0ink.net/nanowiki/">Wiki</a></li>
	            </ul>
	          </aside>
	      </div>

	  </div>

      <footer>

		<p role="contentinfo">
		  © 2021-2022 Alejandro Liu - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
		  <span class="feeds">
		    <a href="/feeds/rss.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="rss feed" title="rss feed"/></a>
		  </span>
		  </p>

	  </footer>

	</div>


</body>
</html>