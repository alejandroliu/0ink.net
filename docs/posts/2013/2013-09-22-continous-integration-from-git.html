<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>Driving Continuous Integration from Git - 0ink.net</title>
	<meta name="author" content="Alejandro Liu">


	<meta name="description" content="Testing, code coverage, style enforcement are all check-in and merge requirements that can be automated and driven from Git. If you're among the rising number of Git users out there, you're in luck: You can automate pieces of your development workflow with Git hooks. Hooks are a native Git mechanism â€¦">
	<meta name="int-title" content="Driving Continuous Integration from Git">
	<meta name="tags" content="config, configuration, directory, feature, git, information, integration, password, remote, scripts, software, terminal, tools">
	<meta name="date" content="2013-09-22 00:00:00+02:00">
	<meta name="modified" content="2021-12-25 21:59:49.800446+01:00">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="/theme/css/main.css" type="text/css" />


    <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="0ink.net Atom Feed" />
    <link href="/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="0ink.net RSS Feed" />
</head>

<body>
    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	        <a href="/feeds/atom.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="atom feed" title="atom feed"/></a>
	    </div>
		<nav class="pages">
			    <a href="/pages/about.html">About</a>
-			    <a href="/pages/privacy-policy.html">Privacy Policy</a>
		</nav>
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		0ink.net</a>
	      <div class="logo">
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		  <img src="/images/2021/0ink.png" width="44" height="44" />
		</a>
	      </div>



      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
			<iframe src="https://duckduckgo.com/search.html?site=0ink.net&prefill=Search with DuckDuckGo" style="overflow:hidden;margin:5px;padding:0;width:408px;height:40px;" frameborder="0"></iframe>

	<article class="full">

		<h1>Driving Continuous Integration from Git</h1>

<div class="metadata">
  <time datetime="2013-09-22T00:00:00+02:00" pubdate>Sun 22 September 2013</time>
    <address class="vcard author">
      by <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
    </address>
  <p>Updated: 2021-12-25 21:59:49.800446+01:00</p>
  in <a href="/category/c2013.html">2013</a>
<p class="tags">tagged <a href="/tag/config.html">config</a>, <a href="/tag/configuration.html">configuration</a>, <a href="/tag/directory.html">directory</a>, <a href="/tag/feature.html">feature</a>, <a href="/tag/git.html">git</a>, <a href="/tag/information.html">information</a>, <a href="/tag/integration.html">integration</a>, <a href="/tag/password.html">password</a>, <a href="/tag/remote.html">remote</a>, <a href="/tag/scripts.html">scripts</a>, <a href="/tag/software.html">software</a>, <a href="/tag/terminal.html">terminal</a>, <a href="/tag/tools.html">tools</a></p></div>
		<p><strong>Testing, code coverage, style enforcement are all check-in and merge
requirements that can be automated and driven from Git.</strong></p>
<p>If you're among the rising number of Git users out there, you're in
luck: You can automate pieces of your development workflow with Git
hooks. Hooks are a native Git mechanism for firing off custom scripts
before or after certain operations such as commit, merge, applypatch,
and others. Think of them as henchmen for your Git repo. Pre-operation
hooks act as bouncers, guarding your repo with a velvet rope. And
post-operation hooks are your Man Friday, faithfully carrying out
follow-up tasks on your behalf.</p>
<p>Installing hooks for a Git repository is fairly straightforward, and
<a href="http://git-scm.com/book/en/Customizing-Git-Git-Hooks">well-documented</a>.
In this article, we focus on using Git hooks to augment continuous
integration practices, starting with an example that makes combining
Git and continuous integration (CI) less painful. The code is written
in Ruby. Fortunately, Ruby is a language that highly prizes readability,
so even if you don't know Ruby, you can easily follow along.</p>
<h1>Automate CI Configuration for Git Branches</h1>
<p>One of the blessings of Git is how easy it is to branch off and develop
in isolation. This means the master stays releasable, you get the
freedom to experiment, and your teammates aren't derailed if code from
the experimentation proves to be half-baked. One challenge of Git,
however, is how many branches a team ends up with ? scores of active
branches, most of which live for only a few days. Who is going to take
the time to set up continuous integration for all those piddly little
branches? Your henchmen, that's who.</p>
<p>To automatically apply CI to new development branches, you'll use the
"post-receive" hook type. These are server-side hooks, triggered after
pushes to the repository are completed. In such cases, you can use the
post-receive hook to fire off a script that programmatically clones a
master's CI configs and applies them to new branches using the CI
server's exposed API. It might look something like this, when using
the open-source and hugely popular <a href="http://www.jenkins-ci.org/">Jenkins</a>
CI server:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env ruby</span>

 <span class="c1"># Ref update hook for creating new Jenkins job </span>
 <span class="c1"># configurations for newly pushed branches.</span>
 <span class="c1">#</span>
 <span class="c1"># requires Ruby 1.9.3+ </span>

 <span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
 <span class="nb">require</span> <span class="s1">&#39;net/https&#39;</span>
 <span class="nb">require</span> <span class="s1">&#39;uri&#39;</span>
 <span class="nb">require</span> <span class="s1">&#39;rexml/document&#39;</span>
 <span class="kp">include</span> <span class="no">REXML</span>

 <span class="c1"># load ci-config.yml from hook directory</span>
 <span class="k">def</span> <span class="nf">load_config</span>
     <span class="n">hookDir</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
     <span class="n">configPath</span> <span class="o">=</span> <span class="n">hookDir</span> <span class="o">+</span> <span class="s2">&quot;/ci-config.yml&quot;</span>
     <span class="nb">puts</span> <span class="n">configPath</span>
     <span class="k">raise</span> <span class="s2">&quot;No ci-config.yml found.&quot;</span> <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span> <span class="n">configPath</span>
     <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">configPath</span><span class="p">)</span>
 <span class="k">end</span>

 <span class="c1"># Grab the configured Jenkins server</span>
 <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span>
 <span class="k">raise</span> <span class="s2">&quot;ci-config.yml file is incomplete: missing jenkins_server&quot;</span> <span class="k">unless</span>
     <span class="n">config</span><span class="o">[</span><span class="s2">&quot;jenkins_server&quot;</span><span class="o">]</span>
 <span class="n">server</span> <span class="o">=</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;jenkins_server&quot;</span><span class="o">]</span>
 <span class="k">raise</span> <span class="s2">&quot;ci-config.yml file is incomplete: username, password, url and</span>
<span class="s2">     default_job are required for jenkins_server&quot;</span> <span class="k">unless</span>
         <span class="n">server</span><span class="o">[</span><span class="s1">&#39;url&#39;</span><span class="o">]</span> <span class="ow">and</span> <span class="n">server</span><span class="o">[</span><span class="s1">&#39;username&#39;</span><span class="o">]</span> <span class="ow">and</span>
         <span class="n">server</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">]</span> <span class="ow">and</span> <span class="n">server</span><span class="o">[</span><span class="s1">&#39;default_job&#39;</span><span class="o">]</span>

 <span class="c1"># iterate through updated refs looking for new branches</span>
 <span class="no">ARGF</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
     <span class="n">args</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span>
     <span class="n">oldVal</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
     <span class="n">newVal</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
     <span class="n">ref</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>

     <span class="k">if</span> <span class="sr">/^0{40}$/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">oldVal</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ref</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;refs/heads/&quot;</span><span class="p">)</span> 
         <span class="c1"># new branch!</span>
         <span class="c1"># retrieve the jenkins job config</span>
         <span class="c1"># TODO only need to do this once!</span>
         <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">#{</span><span class="n">server</span><span class="o">[</span><span class="s1">&#39;url&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/job/</span><span class="si">#{</span><span class="n">server</span><span class="o">[</span><span class="s1">&#39;default_job&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/config.xml&quot;</span><span class="p">)</span>
         <span class="n">req</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Get</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
         <span class="n">req</span><span class="o">.</span><span class="n">basic_auth</span> <span class="n">server</span><span class="o">[</span><span class="s1">&#39;username&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">server</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">]</span>
         <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
         <span class="n">http</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">VERIFY_NONE</span>
         <span class="n">http</span><span class="o">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">eql?</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">)</span>

         <span class="c1"># execute the request</span>
         <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">start</span> <span class="p">{</span><span class="o">|</span><span class="n">http</span><span class="o">|</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">req</span><span class="p">)}</span>

         <span class="k">raise</span> <span class="s2">&quot;Bad response from jenkins, is your ci-config.yml correct?&quot;</span>
             <span class="k">unless</span> <span class="n">response</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTPOK</span>

         <span class="c1"># parse the config.xml from the response</span>
         <span class="n">doc</span> <span class="o">=</span> <span class="no">Document</span><span class="o">.</span><span class="n">new</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
         <span class="n">doc</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">get_elements</span><span class="p">(</span>
             <span class="s2">&quot;//branches/hudson.plugins.git.BranchSpec/name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> 
                 <span class="c1"># overwrite branch to be our new ref</span>
                 <span class="o">|</span><span class="n">elem</span><span class="o">|</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">ref</span> 
         <span class="p">}</span>

         <span class="c1"># create a new request to upload the modified config.xml</span>
         <span class="n">newJob</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
         <span class="n">doc</span><span class="o">.</span><span class="n">write</span> <span class="n">newJob</span>

         <span class="n">newJobName</span> <span class="o">=</span> <span class="n">ref</span><span class="o">[</span><span class="s2">&quot;refs/heads/&quot;</span><span class="o">.</span><span class="n">length</span><span class="o">..-</span><span class="mi">1</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
         <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">server</span><span class="o">[</span><span class="s1">&#39;url&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/createItem?name=</span><span class="si">#{</span><span class="n">newJobName</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        
         <span class="n">req</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Post</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> 
         <span class="n">initheader</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application/xml&#39;</span><span class="p">})</span>

         <span class="n">req</span><span class="o">.</span><span class="n">basic_auth</span> <span class="n">server</span><span class="o">[</span><span class="s1">&#39;username&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">server</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">]</span>
         <span class="n">req</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">newJob</span>

         <span class="c1"># upload the new job</span>
         <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">start</span> <span class="p">{</span><span class="o">|</span><span class="n">http</span><span class="o">|</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">req</span><span class="p">)}</span>
         <span class="k">raise</span> <span class="s2">&quot;Failed to post new job to jenkins&quot;</span> <span class="k">unless</span>
             <span class="n">response</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTPOK</span>
     <span class="k">end</span>
 <span class="p">}</span>
</code></pre></div>

<p>With this hook in place, you need only push a dev branch to the repo,
and it will automatically be put under test. (It's possible to run CI
builds against branches using a build parameter to represent the
target branch, but that muddles the build history. The cloning approach
provides a clean, clear history.) Applying every last facet of the CI
scheme to branches isn't necessary ? for example, running each and
every branch through the load test gamut might be overkill. But even
if you skip the load and UI tests, and run just unit and API- or
integration-level tests, these are huge wins.</p>
<p>The risk of introducing defects into master is greatly reduced by
testing on the branch before merging. Developers can also work more
efficiently and confidently because of the frequent feedback on
changes (instead of the old merge-then-pray technique). And for teams
who include testing as part of their definition of "done," managers
and scrum master types catch a break. With the Git hook automatically
putting branch code under test, the team's practices and values are
being enforced without the need for nag-mails or raised eyebrows during
stand-up.</p>
<h1>Vet Merges to Master</h1>
<p>Two hallmarks of coding craftsmanship are an affinity for automated
tests, and adherence to stylistic rules (such as avoiding empty
try/catch blocks or duplicated code). Despite best intentions, everyone
neglects best practices from time to time. That's where Git hooks come
in. Pre-receive hooks living in the central repository qualify incoming
pushes, making sure they're good enough to get past the velvet rope.
Let's look at three hooks designed to protect master from slip-ups made
on development branches.</p>
<h1>Require Passing Branch Builds</h1>
<p>The whole point of working on a development branch is to isolate
yourself and create a space to experiment (read: "break stuff"). So
it's natural to see failing tests on the branch while development is
in progress. When it's time to merge to master, however, things had
better be tidied up. This can be enforced programmatically with a hook
that checks to see whether the incoming push is a merge to master, and
if so, verify that all tests are passing on the branch before
processing the merge.</p>
<p>If you happen to be using Bamboo, you can cleanly fetch test results
for a given commit. If you use Jenkins or its predecessor, <a href="http://www.hudson-ci.org/">Hudson</a>,
you can fetch a set of recent build results then parse through them
to see which builds ran against the commit in question. (This hook,
and those that follow are implemented for the Bamboo CI server, but
they can be implemented in more or less the same way on all CI
servers.)</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env ruby</span>

 <span class="c1"># Ref update hook for verifying the build status of </span>
 <span class="c1"># a topic branch being merged into </span>
 <span class="c1"># a protected branch (e.g. master) from a Bamboo server.</span>
 <span class="c1">#</span>
 <span class="c1"># requires Ruby 1.9.3+ </span>

 <span class="n">require_relative</span> <span class="s1">&#39;ci-util&#39;</span>
 <span class="nb">require</span> <span class="s1">&#39;json&#39;</span>

 <span class="c1"># parse args supplied by git: &lt;ref_name&gt; &lt;old_sha&gt; &lt;new_sha&gt;</span>
 <span class="n">ref</span> <span class="o">=</span> <span class="n">simple_branch_name</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
 <span class="n">prevCommit</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
 <span class="n">newCommit</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>

 <span class="c1"># test if the updated ref is one we want to enforce green </span>
 <span class="c1"># builds for exit_if_not_protected_ref(ref)</span>

 <span class="c1"># get the tip of the most recently merged branch</span>
 <span class="n">tip_of_merged_branch</span> <span class="o">=</span> 
    <span class="n">find_newest_non_merge_commit</span><span class="p">(</span><span class="n">prevCommit</span><span class="p">,</span> <span class="n">newCommit</span><span class="p">)</span>

 <span class="c1"># parse our Bamboo server config</span>
 <span class="n">bamboo</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="s2">&quot;bamboo&quot;</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="o">]</span><span class="p">)</span>

 <span class="c1"># query Bamboo for build results</span>
 <span class="n">response</span> <span class="o">=</span> <span class="n">httpGet</span><span class="p">(</span>
    <span class="n">bamboo</span><span class="p">,</span> 
    <span class="s2">&quot;/rest/api/latest/result/byChangeset/</span><span class="si">#{</span><span class="n">tip_of_merged_branch</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
 <span class="n">body</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>        
 <span class="c1"># tally the results</span>
 <span class="n">failed</span> <span class="o">=</span> <span class="n">successful</span> <span class="o">=</span> <span class="n">in_progress</span> <span class="o">=</span> <span class="mi">0</span>
 <span class="n">body</span><span class="o">[</span><span class="s1">&#39;results&#39;</span><span class="o">][</span><span class="s1">&#39;result&#39;</span><span class="o">].</span><span class="n">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">result</span><span class="o">|</span>
     <span class="k">case</span> <span class="n">result</span><span class="o">[</span><span class="s1">&#39;state&#39;</span><span class="o">]</span>
     <span class="k">when</span> <span class="s2">&quot;Failed&quot;</span>
       <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
     <span class="k">when</span> <span class="s2">&quot;Successful&quot;</span>
       <span class="n">successful</span> <span class="o">+=</span> <span class="mi">1</span>
     <span class="k">when</span> <span class="s2">&quot;Unknown&quot;</span>
       <span class="k">if</span> <span class="n">result</span><span class="o">[</span><span class="s1">&#39;lifeCycleState&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;InProgress&quot;</span>
         <span class="n">in_progress</span> <span class="o">+=</span> <span class="mi">1</span>
       <span class="k">end</span>
     <span class="k">end</span>
 <span class="p">}</span>

 <span class="c1"># display a short message describing the build status for </span>
 <span class="c1">#the merged branch and abort if necessary</span>
 <span class="k">if</span> <span class="n">failed</span> <span class="o">&gt;</span> <span class="mi">0</span>
     <span class="c1"># at least one red build - block the branch update</span>
     <span class="nb">abort</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shortSha</span><span class="p">(</span><span class="n">tip_of_merged_branch</span><span class="p">)</span><span class="si">}</span><span class="s2"> has </span><span class="si">#{</span><span class="n">failed</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">     red </span><span class="si">#{</span><span class="n">pluralize</span><span class="p">(</span><span class="n">failed</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;builds&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
 <span class="k">elsif</span> <span class="n">in_progress</span> <span class="o">&gt;</span> <span class="mi">0</span>
     <span class="c1"># at least one incomplete build - block the branch update</span>
     <span class="nb">abort</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shortSha</span><span class="p">(</span><span class="n">tip_of_merged_branch</span><span class="p">)</span><span class="si">}</span><span class="s2"> has </span><span class="si">#{</span><span class="n">in_progress</span><span class="si">}</span><span class="s2"></span>
<span class="s2">     </span><span class="si">#{</span><span class="n">pluralize</span><span class="p">(</span><span class="n">in_progress</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;builds&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> that have not</span>
<span class="s2">     completed yet.&quot;</span>
 <span class="k">else</span>   
     <span class="c1"># all green builds - allow the branch update</span>
     <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shortSha</span><span class="p">(</span><span class="n">tip_of_merged_branch</span><span class="p">)</span><span class="si">}</span><span class="s2"> has </span><span class="si">#{</span><span class="n">successful</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">         green </span><span class="si">#{</span><span class="n">pluralize</span><span class="p">(</span><span class="n">successful</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;builds&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
 <span class="k">end</span>
</code></pre></div>

<h1>Enforce Code Coverage Requirements</h1>
<p>Along with successful test runs, you want to make sure that new code
added on development branches is tested as thoroughly as code already
on master. This ensures that the overall test coverage level of the
project doesn't drop when a development branch is merged back in. This,
too, can be checked with Git hooks.</p>
<p>A simple Git hook can verify that coverage on the branch meets the
minimum threshold. To enforce this, a hook can be created to compare
the coverage rate on master with that of the branch, and reject the
merge if the branch's coverage is inferior.</p>
<p>Most CI servers don't expose code coverage data through their remote
APIs. But there's an easy work-around: pulling down the code coverage
report. To do this, the build must be configured to publish the report
as a shared artifact, both on master and on the branch build. (Notice
how automatically cloning build configs for development branches comes
in handy here: set it up for master, and get it on the branch for free!)
Once published, you can get the latest coverage report from master by
a call to the CI server. For branch coverage, you can fetch the
coverage report either from the latest build, or for builds related to
the reference (commit) being merged, as shown here for the code
coverage tool Clover.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env ruby</span>

 <span class="c1"># Ref update hook for asserting the code coverage of a </span>
 <span class="c1"># topic branch being merged into a </span>
 <span class="c1"># protected branch (e.g. master) is the same or better</span>
 <span class="c1">#</span>
 <span class="c1"># requires Ruby 1.9.3+ </span>

 <span class="n">require_relative</span> <span class="s1">&#39;ci-util&#39;</span>
 <span class="nb">require</span> <span class="s1">&#39;rexml/document&#39;</span>

 <span class="kp">include</span> <span class="no">REXML</span>

 <span class="c1"># Determine the code coverage for a particular commit by </span>
 <span class="c1"># parsing Clover artifacts</span>
 <span class="k">def</span> <span class="nf">find_coverage</span><span class="p">(</span><span class="n">bamboo</span><span class="p">,</span> <span class="n">commit</span><span class="p">)</span>
     <span class="c1"># grab the clover.xml artifact from the build. </span>
     <span class="c1"># This (assumes a shared artifact named </span>
     <span class="c1"># &#39;clover&#39; with &#39;clover.xml&#39; at the root).</span>
     <span class="c1"># Change this for your coverage tool?s report name.</span>
     <span class="n">clover_xml</span> <span class="o">=</span> <span class="n">shared_artifact_for_commit</span><span class="p">(</span><span class="n">bamboo</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span>
         <span class="n">bamboo</span><span class="o">[</span><span class="s2">&quot;coverage_key&quot;</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;clover/clover.xml&quot;</span><span class="p">)</span>
     <span class="n">doc</span> <span class="o">=</span> <span class="no">Document</span><span class="o">.</span><span class="n">new</span> <span class="n">clover_xml</span>

     <span class="c1"># parse out the project metrics element from the response</span>
     <span class="n">metrics</span> <span class="o">=</span> <span class="no">XPath</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s2">&quot;coverage/project/metrics&quot;</span><span class="p">)</span>

     <span class="c1"># Use algorithm similar to Clover </span>
     <span class="c1"># (https://confluence.atlassian.com/x/LoHEB) for </span>
     <span class="c1"># determining coverage percentage</span>
     <span class="n">covered_elements</span> <span class="o">=</span> 
         <span class="n">metrics</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s2">&quot;coveredconditionals&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">to_i</span>
     <span class="n">covered_elements</span> <span class="o">+=</span> 
         <span class="n">metrics</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s2">&quot;coveredmethods&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">to_i</span>
     <span class="n">covered_elements</span> <span class="o">+=</span> 
         <span class="n">metrics</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s2">&quot;coveredstatements&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">to_i</span>

     <span class="n">elements</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s2">&quot;conditionals&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">to_i</span>
     <span class="n">elements</span> <span class="o">+=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s2">&quot;methods&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">to_i</span>
     <span class="n">elements</span> <span class="o">+=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s2">&quot;statements&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">to_i</span>

     <span class="n">coverage</span> <span class="o">=</span> <span class="mi">0</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">elements</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
         <span class="n">coverage</span> <span class="o">=</span> <span class="n">covered_elements</span> <span class="o">/</span> <span class="n">elements</span>
     <span class="k">end</span>
     <span class="n">coverage</span>
 <span class="k">end</span>

 <span class="c1"># parse args supplied by git: &lt;ref_name&gt; &lt;old_sha&gt; &lt;new_sha&gt;</span>
 <span class="n">ref</span> <span class="o">=</span> <span class="n">simple_branch_name</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
 <span class="n">prevCommit</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
 <span class="n">newCommit</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>

 <span class="c1"># test if the updated ref is one we want to enforce </span>
 <span class="c1"># green builds for  exit_if_not_protected_ref(ref)</span>

 <span class="c1"># get the tip of the most recently merged branch</span>
 <span class="n">tip_of_merged_branch</span> <span class="o">=</span> 
     <span class="n">find_newest_non_merge_commit</span><span class="p">(</span><span class="n">prevCommit</span><span class="p">,</span> <span class="n">newCommit</span><span class="p">)</span>

 <span class="c1"># parse our bamboo server config</span>
 <span class="n">bamboo</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="s2">&quot;bamboo&quot;</span><span class="p">,</span> 
     <span class="o">[</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;coverage_key&quot;</span><span class="o">]</span><span class="p">)</span>

 <span class="c1"># calculate code coverage for the old and new commits</span>
 <span class="n">prev_coverage</span> <span class="o">=</span> <span class="n">find_coverage</span><span class="p">(</span><span class="n">bamboo</span><span class="p">,</span> <span class="n">prevCommit</span><span class="p">)</span>
 <span class="n">new_coverage</span> <span class="o">=</span> <span class="n">find_coverage</span><span class="p">(</span><span class="n">bamboo</span><span class="p">,</span> <span class="n">tip_of_merged_branch</span><span class="p">)</span>

 <span class="c1"># if the coverage has dropped for the new commit, block the update</span>
 <span class="k">if</span> <span class="n">prev_coverage</span> <span class="o">&gt;</span> <span class="n">new_coverage</span>
     <span class="nb">abort</span> <span class="s2">&quot;Code coverage for </span><span class="si">#{</span><span class="n">shortSha</span><span class="p">(</span><span class="n">tip_of_merged_branch</span><span class="p">)</span><span class="si">}</span><span class="s2"> is </span>
<span class="s2">         only </span><span class="si">#{</span><span class="n">new_coverage</span><span class="si">}</span><span class="s2">! </span><span class="si">#{</span><span class="n">ref</span><span class="si">}</span><span class="s2"> is currently at </span><span class="si">#{</span><span class="n">prev_coverage</span><span class="si">}</span><span class="s2">.&quot;</span> 
 <span class="k">else</span>
     <span class="c1"># if the coverage has increased, TFCIT</span>
     <span class="nb">puts</span> <span class="s2">&quot;Nice work! Code coverage for </span><span class="si">#{</span><span class="n">ref</span><span class="si">}</span><span class="s2"> has </span>
<span class="s2">         increased by </span><span class="si">#{</span><span class="n">new_coverage</span> <span class="o">-</span> <span class="n">prev_coverage</span><span class="si">}</span><span class="s2">.&quot;</span>
 <span class="k">end</span>
</code></pre></div>

<h1>Enforce Good Coding Style</h1>
<p>Tests are something no self-respecting software project can do without,
but they only tell part of the story. Open source tools such as
<a href="http://checkstyle.sourceforge.net/">Checkstyle</a> and 
<a href="http://findbugs.sourceforge.net/">Findbugs</a> scour your codebase and
provide reports on stylistic violations ? anything from duplicated
code to excessively long methods to the use of deprecated methods.
These are hard-won guidelines, and they exist for a reason: Ignoring
them can result in code being harder to understand, harder to maintain,
and more vulnerable to runtime problems.</p>
<p>As with code coverage, each team has a different level of tolerance
for unstylish code. But introducing more style violations is almost
universally agreed-upon as undesirable. In this, Git hooks come to the
rescue. Build artifacts come into play here as well since you can
easily retrieve the violations report. (No CI server we're aware of
exposes static analysis data via remote access API.) So you can create
another pre-receive hook that checks violations for master and the dev
branch, and rejects the push if it would introduce additional errors
into master.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env ruby</span>

 <span class="c1"># Ref update hook for asserting that a topic branch </span>
 <span class="c1"># being merged into a protected</span>
 <span class="c1"># branch (e.g. master) does not introduce an increase in </span>
 <span class="c1"># checkstyle violations</span>
 <span class="c1">#</span>
 <span class="c1"># requires Ruby 1.9.3+ </span>

 <span class="n">require_relative</span> <span class="s1">&#39;ci-util&#39;</span>
 <span class="nb">require</span> <span class="s1">&#39;rexml/document&#39;</span>

 <span class="kp">include</span> <span class="no">REXML</span>

 <span class="c1"># This example </span>
 <span class="k">def</span> <span class="nf">count_checkstyle_violations</span><span class="p">(</span><span class="n">bamboo</span><span class="p">,</span> <span class="n">commit</span><span class="p">)</span>
     <span class="c1"># grab the checkstyle.xml artifact from the </span>
     <span class="c1"># build (assumes a shared artifact named </span>
     <span class="c1"># &#39;checkstyle&#39; with &#39;checkstyle-result.xml&#39; at the root)</span>
     <span class="n">checkstyle_xml</span> <span class="o">=</span> 
         <span class="n">shared_artifact_for_commit</span><span class="p">(</span><span class="n">bamboo</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> 
         <span class="n">bamboo</span><span class="o">[</span><span class="s2">&quot;checkstyle_key&quot;</span><span class="o">]</span><span class="p">,</span>
        <span class="s2">&quot;checkstyle/checkstyle-result.xml&quot;</span><span class="p">)</span>
     <span class="n">doc</span> <span class="o">=</span> <span class="no">Document</span><span class="o">.</span><span class="n">new</span> <span class="n">checkstyle_xml</span>
     <span class="c1"># could go to town on the comparison here - but let&#39;s just count  </span>
     <span class="c1"># the raw number of errors for the time being</span>
     <span class="no">XPath</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s2">&quot;//error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
 <span class="k">end</span>

 <span class="c1"># parse args supplied by git: &lt;ref_name&gt; &lt;old_sha&gt; &lt;new_sha&gt;</span>
 <span class="n">ref</span> <span class="o">=</span> <span class="n">simple_branch_name</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
 <span class="n">prevCommit</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
 <span class="n">newCommit</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>

 <span class="c1"># test if the updated ref is one we want to enforce green builds for</span>
 <span class="n">exit_if_not_protected_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

 <span class="c1"># get the tip of the most recently merged branch</span>
 <span class="n">tip_of_merged_branch</span> <span class="o">=</span> 
    <span class="n">find_newest_non_merge_commit</span><span class="p">(</span><span class="n">prevCommit</span><span class="p">,</span> <span class="n">newCommit</span><span class="p">)</span>

 <span class="c1"># parse our bamboo server config</span>
 <span class="n">bamboo</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="s2">&quot;bamboo&quot;</span><span class="p">,</span> 
    <span class="o">[</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;checkstyle_key&quot;</span><span class="o">]</span><span class="p">)</span>

 <span class="c1"># calculate number of checkstyle violations for </span>
 <span class="c1">#the old and new commits</span>
 <span class="n">prev_violations</span> <span class="o">=</span> 
     <span class="n">count_checkstyle_violations</span><span class="p">(</span><span class="n">bamboo</span><span class="p">,</span> <span class="n">prevCommit</span><span class="p">)</span>
 <span class="n">new_violations</span> <span class="o">=</span> 
     <span class="n">count_checkstyle_violations</span><span class="p">(</span><span class="n">bamboo</span><span class="p">,</span> <span class="n">tip_of_merged_branch</span><span class="p">)</span>

 <span class="c1"># if the number of checkstyle violations has increased, block the update</span>
 <span class="k">if</span> <span class="n">prev_violations</span> <span class="o">&gt;</span> <span class="n">new_violations</span>
     <span class="nb">abort</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shortSha</span><span class="p">(</span><span class="n">tip_of_merged_branch</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">        has </span><span class="si">#{</span><span class="n">new_violations</span><span class="si">}</span><span class="s2"> checkstyle violations! </span><span class="si">#{</span><span class="n">ref</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">        currently has only </span><span class="si">#{</span><span class="n">prev_violations</span><span class="si">}</span><span class="s2">.&quot;</span> 
 <span class="k">else</span>
     <span class="c1"># if the number of checkstyle violations has </span>
     <span class="c1"># decreased, send kudos to the dev</span>
     <span class="nb">puts</span> <span class="s2">&quot;Nice work! </span><span class="si">#{</span><span class="n">ref</span><span class="si">}</span><span class="s2"> has </span><span class="si">#{</span><span class="n">new_violations</span> <span class="o">-</span> <span class="n">prev_violations</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">         fewer checkstyle violations than before.&quot;</span>
 <span class="k">end</span>
</code></pre></div>

<p>To get the original source code and surrounding config files for all
the server-side hooks you've seen here, clone the repo at:
<a href="https://bitbucket.org/tpettersen/git-ci-hooks">bitbucket.org</a>.</p>
<h1>Think Globally, Hook Locally</h1>
<p>We know that the sooner an issue is discovered, the easier (and faster
and cheaper) it is to fix. That's why hooks that operate on local
clones of a repository are so useful: They offer immediate feedback.
Because we don't get the cmd prompt back until a hook completes,
client-side hooks should be limited to operations that take only a few
seconds, lest the development flow be interrupted. Let's look at two
hooks that complete almost instantly.</p>
<h1>Get Branch Build Status</h1>
<p>Exposing branch build status in the terminal window with a
post-checkout hook catches two fish with one worm: It provides
actionable information, and eliminates the need to switch applications
to get it. Upon checkout (and remember, in Git "checkout" means
switching branches, not pulling down code as with SVN and Perforce),
this hook grabs the branch's head revision number from the local copy.
It then queries the CI server to see whether that revision has been
built, and if so, whether the build succeeded.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env ruby</span>

 <span class="c1"># post-checkout hook for determining the build status of the </span>
 <span class="c1"># checked out ref from the CI server.</span>
 <span class="c1">#</span>
 <span class="c1"># Requires Ruby 1.9.3+ </span>

 <span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
 <span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
 <span class="nb">require</span> <span class="s1">&#39;net/https&#39;</span>
 <span class="nb">require</span> <span class="s1">&#39;uri&#39;</span>

 <span class="c1"># utility for correctly pluralizing quantities</span>
 <span class="k">def</span> <span class="nf">pluralize</span> <span class="n">count</span><span class="p">,</span> <span class="n">single</span><span class="p">,</span> <span class="n">multiple</span>
   <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">single</span> <span class="p">:</span> <span class="n">multiple</span>
 <span class="k">end</span>

 <span class="c1"># parse args supplied by git</span>
 <span class="n">ref</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>       <span class="c1"># ref being checked out</span>
 <span class="n">isBranch</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>  <span class="c1"># 0 = file checkout, 1 = branch checkout</span>

 <span class="c1"># we only care about branch checkouts </span>
 <span class="k">if</span> <span class="n">isBranch</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
   <span class="c1"># initialise build status counts</span>
   <span class="n">failed</span> <span class="o">=</span> <span class="n">successful</span> <span class="o">=</span> <span class="n">in_progress</span> <span class="o">=</span> <span class="mi">0</span>

   <span class="c1"># loop through each configured Stash server, retrieving build </span>
   <span class="c1"># statuses for the checked out commit and </span>
   <span class="c1"># counting the number of failed, successful and in progress builds</span>
   <span class="n">hookDir</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
   <span class="n">configPath</span> <span class="o">=</span> <span class="n">hookDir</span> <span class="o">+</span> <span class="s2">&quot;/bamboo-config.yml&quot;</span>
   <span class="k">raise</span> <span class="s2">&quot;No bamboo-config.yml found.&quot;</span> <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span> <span class="n">configPath</span>
   <span class="n">config</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">configPath</span><span class="p">)</span>
   <span class="k">raise</span> <span class="s2">&quot;bamboo-config.yml file is incomplete: </span>
<span class="s2">       username, password &amp; url are required&quot;</span> <span class="k">unless</span>
       <span class="n">config</span><span class="o">[</span><span class="s1">&#39;url&#39;</span><span class="o">]</span> <span class="ow">and</span> <span class="n">config</span><span class="o">[</span><span class="s1">&#39;username&#39;</span><span class="o">]</span> <span class="ow">and</span> <span class="n">config</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">]</span>

   <span class="c1"># normalize base url</span>
   <span class="n">baseUrl</span> <span class="o">=</span> <span class="n">config</span><span class="o">[</span><span class="s1">&#39;url&#39;</span><span class="o">]</span>
   <span class="c1"># assume https if no scheme spcified</span>
   <span class="k">if</span> <span class="ow">not</span> <span class="n">baseUrl</span><span class="o">.</span><span class="n">start_with?</span> <span class="s2">&quot;http&quot;</span>
     <span class="n">baseUrl</span> <span class="o">=</span> <span class="s2">&quot;https://</span><span class="si">#{</span><span class="n">baseUrl</span><span class="si">}</span><span class="s2">&quot;</span>
   <span class="k">end</span>
   <span class="c1"># strip trailing slashes</span>
   <span class="k">while</span> <span class="n">baseUrl</span><span class="o">.</span><span class="n">end_with?</span> <span class="s2">&quot;/&quot;</span>
     <span class="n">baseUrl</span> <span class="o">=</span> <span class="n">baseUrl</span><span class="o">[</span><span class="mi">0</span><span class="o">..-</span><span class="mi">2</span><span class="o">]</span>
   <span class="k">end</span>

   <span class="c1"># prepare a request to hit the build status REST end-point</span>
   <span class="n">build_status_resource</span> <span class="o">=</span> 
       <span class="s2">&quot;</span><span class="si">#{</span><span class="n">baseUrl</span><span class="si">}</span><span class="s2">/rest/api/latest/result/byChangeset&quot;</span>
   <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">build_status_resource</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">req</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Get</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">initheader</span> <span class="o">=</span> 
       <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;Accept&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application/json&#39;</span><span class="p">})</span>
   <span class="n">req</span><span class="o">.</span><span class="n">basic_auth</span> <span class="n">config</span><span class="o">[</span><span class="s1">&#39;username&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">config</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">]</span>
   <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
   <span class="n">http</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">VERIFY_NONE</span>
   <span class="n">http</span><span class="o">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">eql?</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">)</span>

   <span class="c1"># execute the request</span>
   <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">start</span> <span class="p">{</span><span class="o">|</span><span class="n">http</span><span class="o">|</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">req</span><span class="p">)}</span>

   <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTPOK</span>
     <span class="nb">puts</span> <span class="s1">&#39;An unknown error occurred while querying </span>
<span class="s1">         Bamboo for build results.&#39;</span>    
     <span class="nb">exit</span>    
   <span class="k">else</span> 
     <span class="c1"># if the request succeeded, count </span>
     <span class="c1"># the statuses from the response</span>
     <span class="n">body</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>        
     <span class="n">body</span><span class="o">[</span><span class="s1">&#39;results&#39;</span><span class="o">][</span><span class="s1">&#39;result&#39;</span><span class="o">].</span><span class="n">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">result</span><span class="o">|</span>
       <span class="k">case</span> <span class="n">result</span><span class="o">[</span><span class="s1">&#39;state&#39;</span><span class="o">]</span>
       <span class="k">when</span> <span class="s2">&quot;Failed&quot;</span>
           <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
       <span class="k">when</span> <span class="s2">&quot;Successful&quot;</span>
           <span class="n">successful</span> <span class="o">+=</span> <span class="mi">1</span>
       <span class="k">when</span> <span class="s2">&quot;Unknown&quot;</span>
           <span class="k">if</span> <span class="n">result</span><span class="o">[</span><span class="s1">&#39;lifeCycleState&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;InProgress&quot;</span>
             <span class="n">in_progress</span> <span class="o">+=</span> <span class="mi">1</span>
           <span class="k">end</span>
       <span class="k">end</span>
     <span class="p">}</span>
   <span class="k">end</span>   

   <span class="c1"># display a short message describing the build status </span>
   <span class="c1"># for the checked out commit</span>
   <span class="n">shortRef</span> <span class="o">=</span> <span class="n">ref</span><span class="o">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">7</span><span class="o">]</span>
   <span class="k">if</span> <span class="n">failed</span> <span class="o">&gt;</span> <span class="mi">0</span>
     <span class="nb">puts</span> <span class="s2">&quot;Warning! </span><span class="si">#{</span><span class="n">shortRef</span><span class="si">}</span><span class="s2"> has </span><span class="si">#{</span><span class="n">failed</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">          red </span><span class="si">#{</span><span class="n">pluralize</span><span class="p">(</span><span class="n">failed</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;builds&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">          (plus </span><span class="si">#{</span><span class="n">successful</span><span class="si">}</span><span class="s2"> green and </span><span class="si">#{</span><span class="n">in_progress</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">          in progress).</span><span class="se">\n</span><span class="s2">Details: </span><span class="si">#{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&quot;</span>
   <span class="k">elsif</span> <span class="n">successful</span> <span class="o">==</span> <span class="mi">0</span>
       <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shortRef</span><span class="si">}</span><span class="s2"> hasn&#39;t built yet.&quot;</span>
   <span class="k">else</span>
        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shortRef</span><span class="si">}</span><span class="s2"> has </span><span class="si">#{</span><span class="n">successful</span><span class="si">}</span><span class="s2"> green </span>
<span class="s2">            </span><span class="si">#{</span><span class="n">pluralize</span><span class="p">(</span><span class="n">successful</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;builds&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
   <span class="k">end</span>

 <span class="k">end</span>
</code></pre></div>

<p>If, for example, the hook tells you the head commit on the master has
built successfully, then it's a "safe" commit to create a feature
branch from. Or let's say the hook says the build for that revision
failed, yet the team's wallboard shows a green build for that branch
(or vice versa). That means the local copy is out-of-date. Whether to
pull down the updates is determined on a case-by-case basis.</p>
<p>This hook and its config files can be found at <a href="https://bitbucket.org/tpettersen/post-checkout-build-status">bitbucket</a>.</p>
<h1>Sanity-Check Code Style</h1>
<p>Checking for violations at merge time is great, but a pre-commit hook
analyzing the changeset keeps the style police off your back entirely.
Start by capturing the names of files being updated or added and
concatenating them. That string of file names is then passed into the
Checkstyle run command. If violations are found, the commit is rejected.</p>
<p>Note that despite variations between them, all static analysis tools
can be used with this approach. Findbugs, for example, must be run on
the entire project because it looks at methods referenced across
classes. But that's not necessarily a deal-breaker. Small and
medium-sized projects can be fully analyzed quickly, especially if
a generous heap space is allocated to the process.</p>
<h1>Come As You Are</h1>
<p>All the ideas presented here are vendor-neutral. Git hooks may not
revolutionize software development the way continuous integration
has, but every time a task, practice or rule is automated, it's a
win.</p>
<p>From <a href="http://www.drdobbs.com/architecture-and-design/driving-continuous-integration-from-git/240161383">Dr. Dobbs Journal</a></p>

	</article>


		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Years</h2>
	          <ul>
	              <li ><a href="/category/c2021.html">2021</a></li>
	              <li ><a href="/category/c2020.html">2020</a></li>
	              <li ><a href="/category/c2019.html">2019</a></li>
	              <li ><a href="/category/c2018.html">2018</a></li>
	              <li ><a href="/category/c2017.html">2017</a></li>
	              <li ><a href="/category/c2016.html">2016</a></li>
	              <li ><a href="/category/c2015.html">2015</a></li>
	              <li ><a href="/category/c2014.html">2014</a></li>
	              <li class="active"><a href="/category/c2013.html">2013</a></li>
	              <li ><a href="/category/c.html">...</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="https://github.com/alejandroliu/">github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/alejandro-liu-ly/">LinkedIn</a><i></i></li>
			    </ul>
			  </aside>

	          <aside>
	            <h2>Links</h2>
	            <ul>
	                <li><a href="https://github.com/alejandroliu/0ink.net">Repo</a></li>
	                <li><a href="https://alejandro.iliu.net/">Alejandro</a></li>
	                <li><a href="/tags.html">Tags</a></li>
	                <li><a href="/sitemap.html">sitemap</a></li>
	            </ul>
	          </aside>
	      </div>

	  </div>

      <footer>

		<p role="contentinfo">
		  Â© 2021 Alejandro Liu - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
		  <span class="feeds">
		    <a href="/feeds/rss.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="rss feed" title="rss feed"/></a>
		  </span>
		  </p>

	  </footer>

	</div>


</body>
</html>