<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>OpenWRT web - 0ink.net</title>
	<meta name="author" content="Alejandro Liu">


	<meta name="description" content="Some useful tidbits to use when using the OpenWRT embedded web server (uHTTPD). Embedded Lua uHTTPd supports running Lua in-process, which can speed up Lua CGI scripts. It is unclear whether LuCI supports running in this embedded interpreter. LuCI seems to work fine (if not better) with the embedded Lua …">
	<meta name="int-title" content="OpenWRT web">
	<meta name="tags" content="authentication, config, configuration, database, login, password, scripts, settings, speed">
	<meta name="date" content="2013-05-30 00:00:00+02:00">
	<meta name="modified" content="2022-01-10 17:09:50+01:00">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="/theme/css/main.css" type="text/css" />


    <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="0ink.net Atom Feed" />
    <link href="/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="0ink.net RSS Feed" />
</head>

<body>
    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	        <a href="/feeds/atom.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="atom feed" title="atom feed"/></a>
	    </div>
		<nav class="pages">
			    <a href="/pages/about.html">About</a>
-			    <a href="/pages/privacy-policy.html">Privacy Policy</a>
		</nav>
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		0ink.net</a>
	      <div class="logo">
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		  <img src="/images/2021/0ink.png" width="44" height="44" />
		</a>
	      </div>



      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
			<iframe src="https://duckduckgo.com/search.html?site=0ink.net&prefill=Search with DuckDuckGo" style="overflow:hidden;margin:5px;padding:0;width:408px;height:40px;" frameborder="0"></iframe>

	<article class="full">

		<h1>OpenWRT web</h1>

<div class="metadata">
  <time datetime="2013-05-30T00:00:00+02:00" pubdate>Thu 30 May 2013</time>
    <address class="vcard author">
      by <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
    </address>
  <p>Updated: 2022-01-10 17:09:50+01:00</p>
  in <a href="/category/c2013.html">2013</a>
<p class="tags">tagged <a href="/tag/authentication.html">authentication</a>, <a href="/tag/config.html">config</a>, <a href="/tag/configuration.html">configuration</a>, <a href="/tag/database.html">database</a>, <a href="/tag/login.html">login</a>, <a href="/tag/password.html">password</a>, <a href="/tag/scripts.html">scripts</a>, <a href="/tag/settings.html">settings</a>, <a href="/tag/speed.html">speed</a></p></div>
		<p>Some useful tidbits to use when using the OpenWRT embedded web
server (uHTTPD).</p>
<h3 id="embedded-lua">Embedded Lua</h3>
<p>uHTTPd supports running Lua in-process, which can speed up Lua CGI
scripts. It is unclear whether LuCI supports running in this embedded
interpreter. LuCI seems to work fine (if not better) with the embedded
Lua interpreter.</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="err">@</span><span class="n">OpenWrt</span><span class="p">:</span><span class="o">~</span><span class="c1"># opkg install uhttpd-mod-lua</span><span class="w"></span>
<span class="n">Installing</span><span class="w"> </span><span class="n">uhttpd</span><span class="o">-</span><span class="n">mod</span><span class="o">-</span><span class="n">lua</span><span class="w"> </span><span class="p">(</span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">root</span><span class="o">...</span><span class="w"></span>
<span class="n">Downloading</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">downloads</span><span class="o">.</span><span class="n">openwrt</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">snapshots</span><span class="o">/</span><span class="n">trunk</span><span class="o">/</span><span class="n">ar71xx</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">uhttpd</span><span class="o">-</span><span class="n">mod</span><span class="o">-</span><span class="n">lua_18_ar71xx</span><span class="o">.</span><span class="n">ipk</span><span class="o">.</span><span class="w"></span>
<span class="n">Configuring</span><span class="w"> </span><span class="n">uhttpd</span><span class="o">-</span><span class="n">mod</span><span class="o">-</span><span class="n">lua</span><span class="o">.</span><span class="w"></span>
<span class="n">root</span><span class="err">@</span><span class="n">OpenWrt</span><span class="p">:</span><span class="o">~</span><span class="c1"># uci set uhttpd.main.lua_prefix=/lua</span><span class="w"></span>
<span class="n">root</span><span class="err">@</span><span class="n">OpenWrt</span><span class="p">:</span><span class="o">~</span><span class="c1"># uci set uhttpd.main.lua_handler=/root/test.lua</span><span class="w"></span>
<span class="n">root</span><span class="err">@</span><span class="n">OpenWrt</span><span class="p">:</span><span class="o">~</span><span class="c1"># cat /root/test.lua</span><span class="w"></span>
<span class="n">function</span><span class="w"> </span><span class="n">handle_request</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">uhttpd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;HTTP/1.0 200 OKrn&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">uhttpd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Content-Type: text/plainrnrn&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">uhttpd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Hello world.n&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">end</span><span class="w"></span>
<span class="n">root</span><span class="err">@</span><span class="n">OpenWrt</span><span class="p">:</span><span class="o">~</span><span class="c1"># /etc/init.d/uhttpd restart</span><span class="w"></span>
<span class="n">root</span><span class="err">@</span><span class="n">OpenWrt</span><span class="p">:</span><span class="o">~</span><span class="c1"># wget -qO- http://127.0.0.1/lua/</span><span class="w"></span>
<span class="n">Hello</span><span class="w"> </span><span class="n">world</span><span class="o">.</span><span class="w"></span>
<span class="n">root</span><span class="err">@</span><span class="n">OpenWrt</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span><span class="w"></span>
</code></pre></div>

<p>Tested on Backfire 10.03.1 with uHTTPd 28.</p>
<h3 id="https-enable-and-certificate-settings-and-creation">HTTPS Enable and Certificate Settings and Creation</h3>
<p>First of all, you need to install the <code>uhttpd-mod-tls</code> package in order to pull into the system the 'TLS plugin which adds HTTPS support to uHTTPd'. Then if listen_https is defined in the server configuration, the certificate and private key is missing. In this case (as of 10.03.1) you'll need to install the <code>luci-ssl</code> meta-package which in turn will pull also the <code>px5g</code> script. With this utility the init script will generate the appropriate certifcate and key files when the server is started for the first time, either by reboot or by manual restart. The <code>/etc/config/uhttpd</code> file contains in the end a section detailing the certificate and key files creation parameters:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Required</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>days</td>
<td>integer</td>
<td>no</td>
<td>730</td>
<td>Validity time of the generated certificates in days</td>
</tr>
<tr>
<td>bits</td>
<td>integer</td>
<td>no</td>
<td>1024</td>
<td>Size of the generated RSA key in bits</td>
</tr>
<tr>
<td>country</td>
<td>string</td>
<td>no</td>
<td>DE</td>
<td>ISO country code of the certificate issuer</td>
</tr>
<tr>
<td>state</td>
<td>string</td>
<td>no</td>
<td>Berlin</td>
<td>State of the certificate issuer</td>
</tr>
<tr>
<td>location</td>
<td>string</td>
<td>no</td>
<td>Berlin</td>
<td>Location/city of the certificate issuer</td>
</tr>
<tr>
<td>commonname</td>
<td>string</td>
<td>no</td>
<td>OpenWrt</td>
<td>Common name covered by the certificate</td>
</tr>
</tbody>
</table>
<p>Those will be needed only once, at the next restart.</p>
<h3 id="basic-authentication-httpdconf">Basic Authentication (httpd.conf)</h3>
<p>For backward compatibility reasons, uhttpd uses the old Busybox httpd
config file /<code>etc/httpd.conf</code> to define authentication areas and the
associated usernames and passwords. This configuration file is not in
UCI format and usually shipped or generated by external packages like
webif (X-Wrt). Authentication realms are defined in the format
<code>prefix:username:password</code> with one entry per line followed by a
newline.</p>
<ul>
<li>prefix is the URL part covered by the realm, e.g. /cgi-bin to request basic auth for any CGI program</li>
<li>username specifies the username a client has to login with</li>
<li>password defines the secret password required to authenticate</li>
</ul>
<p>The password can be either in plain text format, MD5 encoded or in the
form $p$user where user refers to an account in /etc/shadow or
/etc/passwd. A plain text password can be converted to MD5 encoding by
using the -m switch of the uhttpd executable:</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@OpenWrt</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">uhttpd</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">secret</span><span class="w"></span>
<span class="err">$</span><span class="mi">1</span><span class="err">$$</span><span class="n">ysVNzQc4CTMkp5daOdZ</span><span class="mf">.3</span><span class="o">/</span><span class="w"></span>
</code></pre></div>

<p>If the $p$- format is used, uhttpd will compare the client provided
password against the one stored in the shadow or passwd database.<br>
URL decoding  </p>
<p><strong>Note that this creates a empty salt!</strong></p>
<h3 id="url-decoding">URL decoding</h3>
<p>Like Busybox HTTPd, the URL decoding of strings on the command line is supported through the -d switch:</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@OpenWrt</span><span class="err">:</span><span class="o">/</span><span class="err">#</span><span class="w"> </span><span class="n">uhttpd</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="ss">&quot;An%20URL%20encoded%20String%21%0a&quot;</span><span class="w"></span>
<span class="n">An</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">encoded</span><span class="w"> </span><span class="n">String</span><span class="err">!</span><span class="w"></span>
</code></pre></div>

	</article>


		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Years</h2>
	          <ul>
	              <li ><a href="/category/c2022.html">2022</a></li>
	              <li ><a href="/category/c2021.html">2021</a></li>
	              <li ><a href="/category/c2020.html">2020</a></li>
	              <li ><a href="/category/c2019.html">2019</a></li>
	              <li ><a href="/category/c2018.html">2018</a></li>
	              <li ><a href="/category/c2017.html">2017</a></li>
	              <li ><a href="/category/c2016.html">2016</a></li>
	              <li ><a href="/category/c2015.html">2015</a></li>
	              <li ><a href="/category/c2014.html">2014</a></li>
	              <li class="active"><a href="/category/c2013.html">2013</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="https://github.com/alejandroliu/">github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/alejandro-liu-ly/">LinkedIn</a><i></i></li>
			    </ul>
			  </aside>

	          <aside>
	            <h2>Links</h2>
	            <ul>
	                <li><a href="/sitemap.html">sitemap</a></li>
	                <li><a href="/tags.html">Tags</a></li>
	                <li><a href="https://github.com/alejandroliu/0ink.net">Repo</a></li>
	                <li><a href="https://alejandro.iliu.net/">Alejandro</a></li>
	                <li><a href="https://home.0ink.net/nanowiki/">Wiki</a></li>
	            </ul>
	          </aside>
	      </div>

	  </div>

      <footer>

		<p role="contentinfo">
		  © 2021-2022 Alejandro Liu - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
		  <span class="feeds">
		    <a href="/feeds/rss.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="rss feed" title="rss feed"/></a>
		  </span>
		  </p>

	  </footer>

	</div>


</body>
</html>