<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>Automatically adding systems to an AD domain - 0ink.net</title>
	<meta name="author" content="Alejandro Liu">


	<meta name="description" content="When using virtualisation it is very common to create template VMs that can be cloned from. This makes deployment much easier than having to install a new VM from scratch. Unfortunately, the cloned VMs lack any Active Directory memberships and the VMs have to be manually added to the AD …">
	<meta name="int-title" content="Automatically adding systems to an AD domain">
	<meta name="tags" content="address, computer, configuration, directory, domain, login, manager, password, scripts, security, setup, windows">
	<meta name="date" content="2013-05-19 00:00:00+02:00">
	<meta name="modified" content="2021-12-25 22:02:18+01:00">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="/theme/css/main.css" type="text/css" />


    <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="0ink.net Atom Feed" />
    <link href="/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="0ink.net RSS Feed" />
</head>

<body>
    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	        <a href="/feeds/atom.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="atom feed" title="atom feed"/></a>
	    </div>
		<nav class="pages">
			    <a href="/pages/about.html">About</a>
-			    <a href="/pages/privacy-policy.html">Privacy Policy</a>
		</nav>
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		0ink.net</a>
	      <div class="logo">
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		  <img src="/images/2021/0ink.png" width="44" height="44" />
		</a>
	      </div>



      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
			<iframe src="https://duckduckgo.com/search.html?site=0ink.net&prefill=Search with DuckDuckGo" style="overflow:hidden;margin:5px;padding:0;width:408px;height:40px;" frameborder="0"></iframe>

	<article class="full">

		<h1>Automatically adding systems to an AD domain</h1>

<div class="metadata">
  <time datetime="2013-05-19T00:00:00+02:00" pubdate>Sun 19 May 2013</time>
    <address class="vcard author">
      by <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
    </address>
  <p>Updated: 2021-12-25 22:02:18+01:00</p>
  in <a href="/category/c2013.html">2013</a>
<p class="tags">tagged <a href="/tag/address.html">address</a>, <a href="/tag/computer.html">computer</a>, <a href="/tag/configuration.html">configuration</a>, <a href="/tag/directory.html">directory</a>, <a href="/tag/domain.html">domain</a>, <a href="/tag/login.html">login</a>, <a href="/tag/manager.html">manager</a>, <a href="/tag/password.html">password</a>, <a href="/tag/scripts.html">scripts</a>, <a href="/tag/security.html">security</a>, <a href="/tag/setup.html">setup</a>, <a href="/tag/windows.html">windows</a></p></div>
		<p>When using virtualisation it is very common to create <em>template</em> VMs
that can be cloned from. This makes deployment much easier than having
to install a new VM from scratch. Unfortunately, the cloned VMs lack
any Active Directory memberships and the VMs have to be <em>manually</em>
added to the AD domain. For automated deployment scenarios this is
less than desirable. This recipe intends to solve that issue in a
<em>Hypervisor</em> independant manner. This recipe uses a Visual Basic
script that will automatically join a system to a domain during
Windows system preparation. In Lab Manager these steps can be
performed on a VM Template so that virtual machines cloned from it
will be joined to the domain when the system customization process
runs. A specific Active Directory Organizational Unit can be
specified. The Visual Basic script will contain credentials used for
joining the system to the domain. So, as a security measure the Visual
Basic script is setup to be deleted at the end of a successful
execution.</p>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>Active Directory User Account with permissions to add Computer Objects.</li>
<li>LDAP path syntax to Active Directory Organizational Unit to add the Computer to.</li>
</ul>
<h3 id="steps-on-the-vm-template">Steps on the VM Template</h3>
<h4 id="create-scripts-folder">Create Scripts Folder</h4>
<p><code>C:\Windows\Setup\Scripts</code></p>
<h4 id="create-batch-file">Create Batch File</h4>
<p><code>C:\Windows\Setup\SetupComplete.cmd</code></p>
<div class="highlight"><pre><span></span><code><span class="nv">Start</span> <span class="o">/</span><span class="k">wait</span> <span class="nv">cscript</span> <span class="o">%</span><span class="nv">WINDIR</span><span class="o">%</span>\<span class="nv">Setup</span>\<span class="nv">Scripts</span>\<span class="nv">AddDomain</span>.<span class="nv">vbs</span>
<span class="nv">Del</span> <span class="o">%</span><span class="nv">WINDIR</span><span class="o">%</span>\<span class="nv">Setup</span>\<span class="nv">Scripts</span>\<span class="nv">AddDomain</span>.<span class="nv">vbs</span>
</code></pre></div>

<h4 id="create-vbs-file">Create VBS File</h4>
<p><code>C:\Windows\Setup\Scripts\AddDomain.vbs</code></p>
<div class="highlight"><pre><span></span><code>Const JOIN_DOMAIN             = 1
Const ACCT_CREATE             = 2
Const ACCT_DELETE             = 4
Const WIN9X_UPGRADE           = 16
Const DOMAIN_JOIN_IF_JOINED   = 32
Const JOIN_UNSECURE           = 64
Const MACHINE_PASSWORD_PASSED = 128
Const DEFERRED_SPN_SET        = 256
Const INSTALL_INVOCATION      = 262144

strDomain   = &quot;DomainName&quot;
strOU       = &quot;LDAP\OU\PATH&quot;
strUser     = &quot;Domain\Username&quot;
strPassword = &quot;Password&quot;

Set objNetwork = CreateObject(&quot;WScript.Network&quot;)
strComputer = objNetwork.ComputerName

Set objComputer = _
  GetObject(&quot;winmgmts:{impersonationLevel=Impersonate}!&quot; &amp; _
  strComputer &amp; &quot;rootcimv2:Win32_ComputerSystem.Name=&#39;&quot; _
  &amp; strComputer &amp; &quot;&#39;&quot;)

ReturnValue = objComputer.JoinDomainOrWorkGroup(strDomain, _
   strPassword, _
   strDomain &amp; &quot;\&quot; &amp; strUser, _
   strOU, _
   JOIN_DOMAIN + ACCT_CREATE)
</code></pre></div>

<p>Tip: Start Notepad as administrator to have save access to the folder.
Set the correct values for <code>StrDomain</code>, <code>StrOU</code>, <code>StrUser</code> and <code>StrPassword</code>
Example:</p>
<div class="highlight"><pre><span></span><code>    strDomain = &quot;best.adinternal.com&quot; 
    strOU = &quot;ou=Virtuals,ou=CRE R&amp;D,ou=Beaverton,ou=Shared Management,dc=best,dc=adinternal,dc=com&quot; 
    strUser&amp; = &quot;_adjoinuser&quot; 
    strPassword = &quot;$uperS3curePassw()rd!{13245}&quot; 
</code></pre></div>

<h3 id="deploy-vm">Deploy VM</h3>
<p>Be sure <code>Perform customization</code> is checked and <code>Microsoft Sysprep</code> is
selected on the VM Template properties. <code>Clone the VM Template</code></p>
<p>Tip: Wait around 10 minutes before trying to login to the VM. During
this time the VM is going through the sysprep process which will change
the hostname to the name specified when cloning the VM to a
configuration and join the domain. The process should be complete when
the login screen displays <strong>[Ctrl]+[Alt]+[Delete]</strong> and prompts
for a domain login.</p>
<h3 id="additional-notes">Additional notes</h3>
<p>To improve security we could for example not hardcode login credentials
in the VB script. Instead, we could retrieve them from a web server
(using SSL). This server could reset the Login password for the
addDomain account and send that. Once this is completed, the password
could be reset again. Also, the web server could check the IP address
and referencing DNS/DHCP to see if this machine is indeed being
authorised. Finally, we can place this in a different AD domain (with
the appropriate trust relationships) so that you can apply additional
security policies.</p>
<h3 id="references">References</h3>
<ul>
<li>This recipe was originally published at: <a href="http://www.bonusbits.com/main/HowTo:Setup_a_VM_to_Automatically_Join_to_a_Domain">http://www.bonusbits.com/main/HowTo:Setup_a_VM_to_Automatically_Join_to_a_Domain</a><br>
    Unfortunately I am no longer able to reach this site.</li>
<li><a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1007491">http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1007491</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa392154%28v=vs.85%29.aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/aa392154%28v=vs.85%29.aspx</a></li>
</ul>
<p>Other examples:</p>
<ul>
<li><a href="http://mail-archives.apache.org/mod_mbox/incubator-vcl-user/201112.mbox/%3CCAD7o_XxD2a9j0+V7faE1nTSt-OMT+W9=y4TCvKZ-3q92+czewQ@mail.gmail.com%3E">http://mail-archives.apache.org/mod_mbox/incubator-vcl-user/201112.mbox/%3CCAD7o_XxD2a9j0+V7faE1nTSt-OMT+W9=y4TCvKZ-3q92+czewQ@mail.gmail.com%3E</a></li>
<li><a href="http://www.virtualizationteam.com/virtualization-vmware/vcloud-director/vcloud-director-joining-vms-to-specific-active-directory-domain-ou.html">http://www.virtualizationteam.com/virtualization-vmware/vcloud-director/vcloud-director-joining-vms-to-specific-active-directory-domain-ou.html</a></li>
<li><a href="http://itnervecenter.com/content/deploying-window-server-2008-r2-vmware-template-and-joining-it-domain">http://itnervecenter.com/content/deploying-window-server-2008-r2-vmware-template-and-joining-it-domain</a></li>
<li><a href="http://blogs.citrix.com/2011/09/16/xenclient-auto-join-vms-to-the-activedirectory/">http://blogs.citrix.com/2011/09/16/xenclient-auto-join-vms-to-the-activedirectory/</a></li>
</ul>

	</article>


		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Years</h2>
	          <ul>
	              <li ><a href="/category/c2021.html">2021</a></li>
	              <li ><a href="/category/c2020.html">2020</a></li>
	              <li ><a href="/category/c2019.html">2019</a></li>
	              <li ><a href="/category/c2018.html">2018</a></li>
	              <li ><a href="/category/c2017.html">2017</a></li>
	              <li ><a href="/category/c2016.html">2016</a></li>
	              <li ><a href="/category/c2015.html">2015</a></li>
	              <li ><a href="/category/c2014.html">2014</a></li>
	              <li class="active"><a href="/category/c2013.html">2013</a></li>
	              <li ><a href="/category/c.html">...</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="https://github.com/alejandroliu/">github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/alejandro-liu-ly/">LinkedIn</a><i></i></li>
			    </ul>
			  </aside>

	          <aside>
	            <h2>Links</h2>
	            <ul>
	                <li><a href="https://github.com/alejandroliu/0ink.net">Repo</a></li>
	                <li><a href="https://alejandro.iliu.net/">Alejandro</a></li>
	                <li><a href="/tags.html">Tags</a></li>
	                <li><a href="/sitemap.html">sitemap</a></li>
	            </ul>
	          </aside>
	      </div>

	  </div>

      <footer>

		<p role="contentinfo">
		  © 2021 Alejandro Liu - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
		  <span class="feeds">
		    <a href="/feeds/rss.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="rss feed" title="rss feed"/></a>
		  </span>
		  </p>

	  </footer>

	</div>


</body>
</html>