<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>Diskless Archlinux - 0ink.net</title>
	<meta name="author" content="Alejandro Liu">


	<meta name="description" content="I am still to test this recipe Server Configuration First of all, we must install the following components: A DHCP server to assign IP addresses to our diskless nodes. A TFTP server to transfer the boot image (a requirement of all PXE option roms). A form of network storage (NFS …">
	<meta name="int-title" content="Diskless Archlinux">
	<meta name="tags" content="address, boot, configuration, device, directory, filesystem, information, installation, linux, network, setup, software, storage">
	<meta name="date" content="2013-06-01 00:00:00+02:00">
	<meta name="modified" content="2021-12-25 22:02:18+01:00">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="/theme/css/main.css" type="text/css" />


    <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="0ink.net Atom Feed" />
    <link href="/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="0ink.net RSS Feed" />
</head>

<body>
    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	        <a href="/feeds/atom.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="atom feed" title="atom feed"/></a>
	    </div>
		<nav class="pages">
			    <a href="/pages/about.html">About</a>
-			    <a href="/pages/privacy-policy.html">Privacy Policy</a>
		</nav>
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		0ink.net</a>
	      <div class="logo">
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		  <img src="/images/2021/0ink.png" width="44" height="44" />
		</a>
	      </div>



      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
			<iframe src="https://duckduckgo.com/search.html?site=0ink.net&prefill=Search with DuckDuckGo" style="overflow:hidden;margin:5px;padding:0;width:408px;height:40px;" frameborder="0"></iframe>

	<article class="full">

		<h1>Diskless Archlinux</h1>

<div class="metadata">
  <time datetime="2013-06-01T00:00:00+02:00" pubdate>Sat 01 June 2013</time>
    <address class="vcard author">
      by <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
    </address>
  <p>Updated: 2021-12-25 22:02:18+01:00</p>
  in <a href="/category/c2013.html">2013</a>
<p class="tags">tagged <a href="/tag/address.html">address</a>, <a href="/tag/boot.html">boot</a>, <a href="/tag/configuration.html">configuration</a>, <a href="/tag/device.html">device</a>, <a href="/tag/directory.html">directory</a>, <a href="/tag/filesystem.html">filesystem</a>, <a href="/tag/information.html">information</a>, <a href="/tag/installation.html">installation</a>, <a href="/tag/linux.html">linux</a>, <a href="/tag/network.html">network</a>, <a href="/tag/setup.html">setup</a>, <a href="/tag/software.html">software</a>, <a href="/tag/storage.html">storage</a></p></div>
		<p><em>I am still to test this recipe</em></p>
<h2 id="server-configuration">Server Configuration</h2>
<p>First of all, we must install the following components:</p>
<ul>
<li>A DHCP server to assign IP addresses to our diskless nodes.</li>
<li>A TFTP server to transfer the boot image (a requirement of all PXE option roms).</li>
<li>A form of network storage (NFS or NBD) to export the Arch installation to the diskless node.</li>
</ul>
<p>Note: dnsmasq is capable of simultaneously acting as both DHCP and TFTP server.</p>
<h3 id="network-storage">Network storage</h3>
<p>The primary difference between using NFS and NBD is while with both
you can in fact have multiple clients using the same installation,
with NBD (by the nature of manipulating a filesystem directly) you'll
need to use the copyonwrite mode to do so, which ends up discarding
all writes on client disconnect. In some situations however, this might
be highly desirable. Install nfs-utils on the server.</p>
<div class="highlight"><pre><span></span><code># pacman -Syu nfs-utils
</code></pre></div>

<h3 id="nfsv4">NFSv4</h3>
<p>You'll need to add the root of your arch installation to your NFS exports:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># vim /etc/exports</span>
<span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">arch</span> <span class="o">*</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">fsid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">no_root_squash</span><span class="p">,</span><span class="n">no_subtree_check</span><span class="p">)</span>
</code></pre></div>

<p>Next, start NFS.</p>
<div class="highlight"><pre><span></span><code># systemctl start rpc-idmapd.service rpc-mountd.service
</code></pre></div>

<h3 id="nfsv3">NFSv3</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># vim /etc/exports</span>
<span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">arch</span> <span class="o">*</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">no_root_squash</span><span class="p">,</span><span class="n">no_subtree_check</span><span class="p">,</span><span class="n">sync</span><span class="p">)</span>
</code></pre></div>

<p>Next, start NFSv3.</p>
<div class="highlight"><pre><span></span><code># systemctl start rpc-mountd.service rpc-statd.service
</code></pre></div>

<p>Note: If you're not worried about data loss in the event of network
and/or server failure, replace sync with async--additional options
can be found in the NFS article.</p>
<h3 id="nbd">NBD</h3>
<p>Install nbd .</p>
<div class="highlight"><pre><span></span><code># pacman -Syu nbd
</code></pre></div>

<p>Configure nbd.</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">vim</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nbd</span><span class="o">-</span><span class="n">server</span><span class="o">/</span><span class="n">config</span><span class="w"></span>
<span class="o">[</span><span class="n">generic</span><span class="o">]</span><span class="w"></span>
<span class="w">    </span><span class="k">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nbd</span><span class="w"></span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nbd</span><span class="w"></span>
<span class="o">[</span><span class="n">arch</span><span class="o">]</span><span class="w"></span>
<span class="w">    </span><span class="n">exportname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">arch</span><span class="p">.</span><span class="n">img</span><span class="w"></span>
<span class="w">    </span><span class="n">copyonwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"></span>
</code></pre></div>

<p>Note: Set copyonwrite to true if you want to have multiple clients
using the same NBD share simultaneously; refer to man 5 nbd-server for
more details. Start nbd.</p>
<div class="highlight"><pre><span></span><code># systemctl start nbd.service
</code></pre></div>

<h2 id="client-installation">Client installation</h2>
<p>Next we will create a full Arch Linux installation in a subdirectory on
the server. During boot, the diskless client will get an IP address from
the DHCP server, then boot from the host using PXE and mount this
installation as its root.</p>
<h3 id="directory-setup">Directory setup</h3>
<h4 id="nbd_1">NBD</h4>
<p>Create a sparse file of at least 1 gigabyte, and create a btrfs
filesystem on it (you can of course also use a real block device or
LVM if you so desire).</p>
<div class="highlight"><pre><span></span><code><span class="c1"># truncate -s 1G /srv/arch.img</span>
<span class="c1"># mkfs.btrfs /srv/arch.img</span>
<span class="c1"># export root=/srv/arch</span>
<span class="c1"># mkdir -p &quot;$root&quot;</span>
<span class="c1"># mount -o loop,discard,compress=lzo /srv/arch.img &quot;$root&quot;</span>
</code></pre></div>

<p>Note: Creating a separate filesystem is required for NBD but optional
for NFS and can be skipped/ignored.</p>
<h3 id="bootstrapping-installation">Bootstrapping installation</h3>
<p>Install devtools and arch-install-scripts , and run mkarchroot.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># pacman -Syu devtools arch-install-scripts</span>
<span class="c1"># mkarchroot -f &quot;$root&quot; base mkinitcpio-nfs-utils nfs-utils</span>
</code></pre></div>

<p>Note: In all cases mkinitcpio-nfs-utils is still required--ipconfig used
in early-boot is provided only by the latter. Now the initramfs needs to
be constructed. The shortest configuration, <code>#NFSv3</code>, is presented as a
"base" upon which all subsequent sections modify as-needed.</p>
<h4 id="nfsv3_1">NFSv3</h4>
<div class="highlight"><pre><span></span><code># vim &quot;$root/etc/mkinitcpio.conf&quot;
MODULES=&quot;nfsv3&quot;
HOOKS=&quot;base udev autodetect net filesystems&quot;
BINARIES=&quot;&quot;
</code></pre></div>

<p>Note: You'll also need to add the appropriate module for your ethernet
controller to the MODULES array. The initramfs now needs to be rebuilt;
the easiest way to do this is via arch-chroot .</p>
<div class="highlight"><pre><span></span><code># <span class="nv">arch</span><span class="o">-</span><span class="nv">chroot</span> <span class="s2">&quot;</span><span class="s">$root</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">bash</span>
<span class="ss">(</span><span class="nv">chroot</span><span class="ss">)</span> # <span class="nv">mkinitcpio</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">linux</span>
<span class="ss">(</span><span class="nv">chroot</span><span class="ss">)</span> # <span class="k">exit</span>
</code></pre></div>

<h4 id="nfsv4_1">NFSv4</h4>
<p>Trivial modifications to the net hook are required in order for NFSv4
mounting to work (not supported by nfsmount--the default for the net hook).</p>
<div class="highlight"><pre><span></span><code># sed s/nfsmount/mount.nfs4/ &quot;$root/usr/lib/initcpio/hooks/net&quot; | tee &quot;$root/usr/lib/initcpio/hooks/net_nfs4&quot;
# cp &quot;$root/usr/lib/initcpio/install/{net,net_nfs4}&quot;
</code></pre></div>

<p>The copy of net is unfortunately needed so it does not get overwritten
when mkinitcpio-nfs-utils is updated on the client installation. From
the base mkinitcpio.conf, replace the nfsv3 module with nfsv4, replace
net with net_nfs4, and add /sbin/mount.nfs4 to BINARIES.</p>
<h4 id="nbd_2">NBD</h4>
<p>The mkinitcpio-nbd package needs to be installed on the client.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># pacman --root &quot;$root&quot; --dbpath &quot;$root/var/lib/pacman&quot; -U mkinitcpio-nbd-0.4-1-any.pkg.tar</span>
</code></pre></div>

<p>You will then need to append nbd to your HOOKS array after net; net
will configure your networking for you, but not attempt a NFS mount if
nfsroot is not specified in the kernel line.</p>
<h3 id="client-configuration">Client configuration</h3>
<p>In addition to the setup mentioned here, you should also set up your
hostname, timezone, locale, and keymap , and follow any other relevant
parts of the Installation Guide .</p>
<h2 id="bootloader">Bootloader</h2>
<h3 id="pxelinux">Pxelinux</h3>
<p>Install syslinux .</p>
<div class="highlight"><pre><span></span><code># pacman -Syu syslinux
</code></pre></div>

<p>Copy the pxelinux bootloader (provided by the syslinux package) to the
boot directory of the client.</p>
<div class="highlight"><pre><span></span><code># cp /usr/lib/syslinux/pxelinux.0 &quot;$root/boot&quot;
# mkdir &quot;$root/boot/pxelinux.cfg&quot;
</code></pre></div>

<p>We also created the pxelinux.cfg directory, which is where pxelinux
searches for configuration files by default. Because we don't want to
discriminate between different host MACs, we then create the default
configuration.</p>
<div class="highlight"><pre><span></span><code># vim &quot;$root/boot/pxelinux.cfg/default&quot;

default linux

label linux
kernel vmlinuz-linux
append initrd=initramfs-linux.img ip=:::::eth0:dhcp nfsroot=10.0.0.1:/
</code></pre></div>

<p>NFSv3 mountpoints are relative to the root of the server, not fsid=0.
If you're using NFSv3, you'll need to pass 10.0.0.1:/srv/arch to
nfsroot. Or if you are using NBD, use the following append line:</p>
<div class="highlight"><pre><span></span><code>append ro initrd=initramfs-linux.img ip=:::::eth0:dhcp nbd_host=10.0.0.1 nbd_name=arch root=/dev/nbd0
</code></pre></div>

<p>Note: You will need to change nbd_host and/or nfsroot, respectively,
to match your network configuration (the address of the NFS/NBD server)
The pxelinux configuration syntax identical to syslinux; refer to the
upstream documentation for more information. The kernel and initramfs
will be transferred via TFTP, so the paths to those are going to be
relative to the TFTP root. Otherwise, the root filesystem is going to
be the NFS mount itself, so those are relative to the root of the NFS server.</p>
<div class="highlight"><pre><span></span><code># vim &quot;$root/etc/fstab&quot;

/dev/nbd0  /  btrfs  rw,noatime,discard,compress=lzo  0 0
</code></pre></div>

<h3 id="program-state-directories">Program state directories</h3>
<p>You could mount /var/log, for example, as tmpfs so that logs from
multiple hosts don't mix unpredictably, and do the same with
/var/spool/cups, so the 20 instances of cups using the same spool
don't fight with each other and make 1,498 print jobs and eat an entire
ream of paper (or worse: toner cartridge) overnight.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># vim &quot;$root/etc/fstab&quot;</span>
<span class="n">tmpfs</span>   <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span>        <span class="n">tmpfs</span>     <span class="n">nodev</span><span class="p">,</span><span class="n">nosuid</span>    <span class="mi">0</span> <span class="mi">0</span>
<span class="n">tmpfs</span>   <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">cups</span> <span class="n">tmpfs</span>     <span class="n">nodev</span><span class="p">,</span><span class="n">nosuid</span>    <span class="mi">0</span> <span class="mi">0</span>
</code></pre></div>

<p>It would be best to configure software that has some sort of
state/database to use unique state/database storage directories for
each host. If you wanted to run puppet , for example, you could simply
use the %H specifier in the puppet unit file:</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">vim</span><span class="w"> </span><span class="ss">&quot;$root/etc/systemd/system/puppetagent.service&quot;</span><span class="w"></span>
<span class="o">[</span><span class="n">Unit</span><span class="o">]</span><span class="w"></span>
<span class="n">Description</span><span class="o">=</span><span class="n">Puppet</span><span class="w"> </span><span class="n">agent</span><span class="w"></span>
<span class="n">Wants</span><span class="o">=</span><span class="n">basic</span><span class="p">.</span><span class="n">target</span><span class="w"></span>
<span class="k">After</span><span class="o">=</span><span class="n">basic</span><span class="p">.</span><span class="n">target</span><span class="w"> </span><span class="n">network</span><span class="p">.</span><span class="n">target</span><span class="w"></span>

<span class="o">[</span><span class="n">Service</span><span class="o">]</span><span class="w"></span>
<span class="n">Type</span><span class="o">=</span><span class="n">forking</span><span class="w"></span>
<span class="n">PIDFile</span><span class="o">=/</span><span class="n">run</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">agent</span><span class="p">.</span><span class="n">pid</span><span class="w"></span>
<span class="n">ExecStartPre</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">puppet</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="mi">755</span><span class="w"> </span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">puppet</span><span class="w"></span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">puppet</span><span class="w"> </span><span class="n">agent</span><span class="w"> </span><span class="o">--</span><span class="n">vardir</span><span class="o">=/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">puppet</span><span class="o">-%</span><span class="n">H</span><span class="w"> </span><span class="o">--</span><span class="n">ssldir</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">ssl</span><span class="o">-%</span><span class="n">H</span><span class="w"></span>

<span class="o">[</span><span class="n">Install</span><span class="o">]</span><span class="w"></span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="k">user</span><span class="p">.</span><span class="n">target</span><span class="w"></span>
</code></pre></div>

<p>Puppet-agent creates vardir and ssldir if they do not exist. If neither
of these approaches are appropriate, the last sane option would be to
create a systemd generator that creates a mount unit specific to the
current host (specifiers are not allowed in mount units, unfortunately).</p>

	</article>


		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Years</h2>
	          <ul>
	              <li ><a href="/category/c2021.html">2021</a></li>
	              <li ><a href="/category/c2020.html">2020</a></li>
	              <li ><a href="/category/c2019.html">2019</a></li>
	              <li ><a href="/category/c2018.html">2018</a></li>
	              <li ><a href="/category/c2017.html">2017</a></li>
	              <li ><a href="/category/c2016.html">2016</a></li>
	              <li ><a href="/category/c2015.html">2015</a></li>
	              <li ><a href="/category/c2014.html">2014</a></li>
	              <li class="active"><a href="/category/c2013.html">2013</a></li>
	              <li ><a href="/category/c.html">...</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="https://github.com/alejandroliu/">github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/alejandro-liu-ly/">LinkedIn</a><i></i></li>
			    </ul>
			  </aside>

	          <aside>
	            <h2>Links</h2>
	            <ul>
	                <li><a href="https://github.com/alejandroliu/0ink.net">Repo</a></li>
	                <li><a href="https://alejandro.iliu.net/">Alejandro</a></li>
	                <li><a href="/tags.html">Tags</a></li>
	                <li><a href="/sitemap.html">sitemap</a></li>
	            </ul>
	          </aside>
	      </div>

	  </div>

      <footer>

		<p role="contentinfo">
		  © 2021 Alejandro Liu - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
		  <span class="feeds">
		    <a href="/feeds/rss.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="rss feed" title="rss feed"/></a>
		  </span>
		  </p>

	  </footer>

	</div>


</body>
</html>