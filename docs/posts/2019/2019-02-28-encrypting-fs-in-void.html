<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>Encrypting FileSystem in Void Linux - 0ink.net</title>
	<meta name="author" content="Alejandro Liu">


	<meta name="description" content="The point of this recipe is to create a encrypted file sytem so that when the disc is disposed, it does not need to be securely erased. This is particularly important for SSD devices since because of block remapping (for wear levelling) data can't be overwritten consistently. The idea is …">
	<meta name="int-title" content="Encrypting FileSystem in Void Linux">
	<meta name="tags" content="backup, boot, device, filesystem, idea, partition">
	<meta name="date" content="2019-02-28 00:00:00+01:00">
	<meta name="revised" content="2021-12-22">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="/theme/css/main.css" type="text/css" />


</head>

<body>

    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	    </div>
		<nav class="pages">
			    <a href="/pages/about.html">About</a>
-			    <a href="/pages/privacy-policy.html">Privacy Policy</a>
		</nav>
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		0ink.net</a>
	      <div class="logo">
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		  <img src="/images/2021/0ink.png" width="44" height="44" />
		</a>
	      </div>



      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
			<iframe src="https://duckduckgo.com/search.html?site=0ink.net&prefill=Search with DuckDuckGo" style="overflow:hidden;margin:5px;padding:0;width:408px;height:40px;" frameborder="0"></iframe>

	<article class="full">

		<h1>Encrypting FileSystem in Void Linux</h1>

<div class="metadata">
  <time datetime="2019-02-28T00:00:00+01:00" pubdate>Thu 28 February 2019</time>
    <address class="vcard author">
      by <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
    </address>
  in <a href="/category/c2019.html">2019</a>
<p class="tags">tagged <a href="/tag/backup.html">backup</a>, <a href="/tag/boot.html">boot</a>, <a href="/tag/device.html">device</a>, <a href="/tag/filesystem.html">filesystem</a>, <a href="/tag/idea.html">idea</a>, <a href="/tag/partition.html">partition</a></p></div>
		<p>The point of this recipe is to create a encrypted file sytem
so that when the disc is disposed, it does not need to be
securely erased.  This is particularly important for SSD devices
since because of block remapping (for wear levelling) data can't
be overwritten consistently.</p>
<p>The idea is that the boot/root filesystem containing the encryption
keys are stored in a different device as the encrypted file system.</p>
<hr>
<p>Generate a passphrase and save it a safe place for later.</p>
<h1>Create block devices</h1>
<div class="highlight"><pre><span></span><code>xbps-install -S lvm2 cryptsetup
cryptsetup luksFormat /dev/xda2
cryptsetup luksOpen /dev/xda2 crypt-pool
vgcreate pool /dev/mapper/crypt-pool
lvcreate --name home0 -L 20G pool
</code></pre></div>

<p>Add <code>rd.luks.crypttab=1 rd.luks=1</code> to the kernel command line.</p>
<h1>Create a decryption key</h1>
<p>Create the key file in the unencrypted <code>/</code> partition</p>
<div class="highlight"><pre><span></span><code><span class="nv">dd</span> <span class="k">if</span><span class="o">=/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">urandom</span> <span class="nv">of</span><span class="o">=/</span><span class="nv">crypto_keyfile</span>.<span class="nv">bin</span> <span class="nv">bs</span><span class="o">=</span><span class="mi">1024</span> <span class="nv">count</span><span class="o">=</span><span class="mi">4</span>
<span class="nv">chmod</span> <span class="mi">000</span> <span class="o">/</span><span class="nv">crypto_keyfile</span>.<span class="nv">bin</span>
<span class="nv">cryptsetup</span> <span class="o">-</span><span class="nv">v</span> <span class="nv">luksAddKey</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">xda2</span> <span class="o">/</span><span class="nv">crypto_keyfile</span>.<span class="nv">bin</span>
</code></pre></div>

<p>Look up the UUID</p>
<div class="highlight"><pre><span></span><code>blkid /dev/xda2
</code></pre></div>

<p>Create entry in <code>/etc/crypttab</code>:</p>
<div class="highlight"><pre><span></span><code>crypt-pool  UUID=xxxxxxxxxxxxxxxx /crypto_keyfile.bin luks
</code></pre></div>

<p>Create <code>/etc/dracut.conf.d/10-crypt.conf</code></p>
<div class="highlight"><pre><span></span><code>install_items+=&quot;/etc/crypttab /crypto_keyfile.bin&quot;
</code></pre></div>

<p>Update initrd:</p>
<div class="highlight"><pre><span></span><code>xbps-reconfigure -f linux4.19
</code></pre></div>

<p>Update boot menu entries:</p>
<div class="highlight"><pre><span></span><code>bash /boot/mkmenu.sh
</code></pre></div>

<p>At this point it would be good to save:</p>
<ul>
<li><code>/etc/crypttab</code></li>
<li><code>/crypto_keyfile.bin</code></li>
<li>Optionally, passphrase</li>
</ul>
<hr>
<p>Reboot and make sure that the block device gets created on start-up.</p>
<p>Create your file-system and add it to <code>/etc/fstab</code>.</p>
<h1>Re-using an existing fs in a new OS install</h1>
<p>Usually this procedure would be used on a fresh install when the
root filesystem was destroyed.  It requires to have a backup of the
<code>/crypto_keyfile.bin</code> and optionally the <code>/etc/crypttab</code>.</p>
<ol>
<li>Add <code>rd.luks.crypttab=1 rd.luks=1</code> to the kernel command line.</li>
<li>Restore the <code>/crypto_keyfile.bin</code>.  Make sure it is in <code>/</code> and
   permissions are <code>chmod 000 /crypto_keyfile.bin</code>.</li>
<li>If available, restore the <code>/etc/crypttab</code> otherwise look up the
   block device UUID and re-create the <code>/etc/crypttab</code> entry:</li>
<li>Look-up the UUID:</li>
<li><code>blkid /dev/xda2</code></li>
<li>Add the entry in <code>/etc/crypttab</code></li>
<li><code>crypt-pool    UUID=xxxxxxxxxxxxxxxx /crypto_keyfile.bin luks</code></li>
<li>Create <code>/etc/dracut.conf.d/10-crypt.conf</code></li>
<li><code>install_items+="/etc/crypttab /crypto_keyfile.bin"</code></li>
<li>Update initrd:</li>
<li><code>xbps-reconfigure -f linux4.19</code></li>
<li>Update boot menu entries:</li>
<li><code>bash /boot/mkmenu.sh</code></li>
</ol>

	</article>


		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Years</h2>
	          <ul>
	              <li ><a href="/category/c2021.html">2021</a></li>
	              <li ><a href="/category/c2020.html">2020</a></li>
	              <li class="active"><a href="/category/c2019.html">2019</a></li>
	              <li ><a href="/category/c2018.html">2018</a></li>
	              <li ><a href="/category/c2017.html">2017</a></li>
	              <li ><a href="/category/c2016.html">2016</a></li>
	              <li ><a href="/category/c2015.html">2015</a></li>
	              <li ><a href="/category/c2014.html">2014</a></li>
	              <li ><a href="/category/c2013.html">2013</a></li>
	              <li ><a href="/category/c.html">...</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="https://github.com/alejandroliu/">github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/alejandro-liu-ly/">LinkedIn</a><i></i></li>
			    </ul>
			  </aside>

	          <aside>
	            <h2>Links</h2>
	            <ul>
	                <li><a href="https://github.com/alejandroliu/0ink.net">Repo</a></li>
	                <li><a href="https://alejandro.iliu.net/">Alejandro</a></li>
	                <li><a href="/tags.html">Tags</a></li>
	                <li><a href="/sitemap.html">sitemap</a></li>
	            </ul>
	          </aside>
	      </div>

	  </div>

      <footer>

		<p role="contentinfo">
		  © 2021 Alejandro Liu - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
    	</p>

	  </footer>

	</div>


</body>
</html>