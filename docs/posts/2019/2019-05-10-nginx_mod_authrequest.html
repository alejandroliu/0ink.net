<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>nginx's auth_request_module howto - 0ink.net</title>
	<meta name="author" content="Alejandro Liu">


	<meta name="description" content="This article tries to supplement the nginx documentations regarding the auth_request module and how to configure it. In my opinion, that documentation is a bit incomplete. What is the nginx's auth_request module The documentation for this module says, it implements client authorization based on the result of a subrequest. This â€¦">
	<meta name="int-title" content="nginx's auth_request_module howto">
	<meta name="tags" content="authentication, configuration, information, login, password, proxy, python">
	<meta name="date" content="2019-05-10 00:00:00+02:00">
	<meta name="modified" content="2022-01-04 18:38:11+01:00">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="/theme/css/main.css" type="text/css" />


    <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="0ink.net Atom Feed" />
    <link href="/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="0ink.net RSS Feed" />
</head>

<body>
    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	        <a href="/feeds/atom.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="atom feed" title="atom feed"/></a>
	    </div>
		<nav class="pages">
			    <a href="/pages/about.html">About</a>
-			    <a href="/pages/privacy-policy.html">Privacy Policy</a>
		</nav>
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		0ink.net</a>
	      <div class="logo">
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		  <img src="/images/2021/0ink.png" width="44" height="44" />
		</a>
	      </div>



      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
			<iframe src="https://duckduckgo.com/search.html?site=0ink.net&prefill=Search with DuckDuckGo" style="overflow:hidden;margin:5px;padding:0;width:408px;height:40px;" frameborder="0"></iframe>

	<article class="full">

		<h1>nginx's auth_request_module howto</h1>

<div class="metadata">
  <time datetime="2019-05-10T00:00:00+02:00" pubdate>Fri 10 May 2019</time>
    <address class="vcard author">
      by <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
    </address>
  <p>Updated: 2022-01-04 18:38:11+01:00</p>
  in <a href="/category/c2019.html">2019</a>
<p class="tags">tagged <a href="/tag/authentication.html">authentication</a>, <a href="/tag/configuration.html">configuration</a>, <a href="/tag/information.html">information</a>, <a href="/tag/login.html">login</a>, <a href="/tag/password.html">password</a>, <a href="/tag/proxy.html">proxy</a>, <a href="/tag/python.html">python</a></p></div>
		<p>This article tries to supplement the <a href="http://nginx.org/en/">nginx</a> documentations
regarding the <a href="http://nginx.org/en/docs/http/ngx_http_auth_request_module.html">auth_request</a> module
and how to <a href="https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-subrequest-authentication/">configure</a> it.  In my opinion, that documentation
is a bit incomplete.</p>
<h2 id="what-is-the-nginxs-auth_request-module">What is the nginx's <a href="http://nginx.org/en/docs/http/ngx_http_auth_request_module.html">auth_request</a> module</h2>
<p>The documentation for this module says, it implements client
authorization based on the result of a subrequest.</p>
<p>This means that when you make an HTTP request to a protected URL,
<a href="http://nginx.org/en/">nginx</a> performs an internal subrequest to a defined
authorization URL. If the result of the subrequest is HTTP 2xx,
<a href="http://nginx.org/en/">nginx</a> proxies the original HTTP request to the backend server.
If the result of the subrequest is HTTP 401 or 403, access to the
backend server is denied.</p>
<p>By configuring <a href="http://nginx.org/en/">nginx</a>, you can redirect those 401s or 403s to
a login page where the user is authenticated and then redirected to
the original destination.</p>
<p>The entire authorization subrequest process is then repeated, but
because the user is now authenticated the subrequest returns HTTP 200
and the original HTTP request is proxied to the backend server.</p>
<h2 id="configuring-nginx">Configuring <a href="http://nginx.org/en/">nginx</a></h2>
<p>In your <a href="http://nginx.org/en/">nginx</a> configuration...</p>
<p>This block configures the web server area that will be protected:</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">location</span><span class="w"> </span><span class="s">/hello</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kn">error_page</span><span class="w"> </span><span class="mi">401</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">@error401</span><span class="p">;</span><span class="w">   </span><span class="c1"># Specific login page to use</span>
<span class="w">          </span><span class="kn">auth_request</span><span class="w"> </span><span class="s">/auth</span><span class="p">;</span><span class="w">       </span><span class="c1"># The sub-request to use</span>
<span class="w">          </span><span class="kn">auth_request_set</span><span class="w"> </span><span class="nv">$username</span><span class="w"> </span><span class="nv">$upstream_http_x_username</span><span class="p">;</span><span class="w"> </span><span class="c1"># Make the sub request data available</span>
<span class="w">          </span><span class="kn">auth_request_set</span><span class="w"> </span><span class="nv">$sid</span><span class="w"> </span><span class="nv">$upstream_http_x_session</span><span class="p">;</span><span class="w">   </span><span class="c1"># send what is needed</span>

<span class="w">          </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://sample.com:8080/hello</span><span class="p">;</span><span class="w">  </span><span class="c1"># actual location of protected data</span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span><span class="w">  </span><span class="c1"># Custom headers with authentication related data</span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Remote-User</span><span class="w"> </span><span class="nv">$username</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Remote-SID</span><span class="w"> </span><span class="nv">$sid</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">location</span><span class="w"> </span><span class="s">@error401</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kn">return</span><span class="w"> </span><span class="mi">302</span><span class="w"> </span><span class="s">/login/?url=http://</span><span class="nv">$http_host$request_uri</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>

<ul>
<li><code>error_page 401</code> defines the custom login page to use (if any).
  In theory, for a REST API, would be possible to authenticate
  using a provided <code>token</code> header which makes the login page
  unnecesary.</li>
<li><code>auth_request /auth</code> defines that this location needs authentication
  and defines the sub-request location to use.</li>
<li><code>auth_request_set</code> can be used to get data from the subrequest
  headers and make it available later (like for instance, to a
  backend content server using custom headers.</li>
<li><code>proxy_pass</code> defines the actual backend content server.</li>
<li><code>proxy_set_header</code> defines custom header used to pass information
  to the content backend server.</li>
</ul>
<p>This block configures the authentication sub-request server:</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">location</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">/auth</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://auth-server.sample.com:8080/auth</span><span class="p">;</span><span class="w">   </span><span class="c1"># authentication server</span>
<span class="w">          </span><span class="kn">proxy_pass_request_body</span><span class="w"> </span><span class="no">off</span><span class="p">;</span><span class="w">              </span><span class="c1"># no data is being transferred...</span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Content-Length</span><span class="w"> </span><span class="s">&#39;0&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span><span class="w">              </span><span class="c1"># Custom headers with authentication related data</span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Origin-URI</span><span class="w"> </span><span class="nv">$request_uri</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>

<ul>
<li><code>proxy_pass</code> where the sub request should be handled.</li>
<li><code>proxy_pass_request_body off</code> and <code>proxy_set_header Content-Length 0</code> are
  used to supress the content body and only sends the headers to the
  authentication server.</li>
<li><code>proxy_set_header</code> additional details being send to the sub request.
  For example, the <code>X-Origin-URI</code>.</li>
</ul>
<p>This implements the login pager URL</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="c1"># If the user is not logged in, redirect them to login URL</span>
<span class="w">        </span><span class="k">location</span><span class="w"> </span><span class="s">@error401</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kn">return</span><span class="w"> </span><span class="mi">302</span><span class="w"> </span><span class="s">https://</span><span class="nv">$host/login/?url=https://$http_host$request_uri</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>In this example, the login page is on the same reverse proxy, but
it doesn't have to be that way.</p>
<p>The actual login page:</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">location</span><span class="w"> </span><span class="s">/login/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://auth-server.sample.com:8080/login/</span><span class="p">;</span><span class="w"> </span><span class="c1"># Where the login happens</span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-My-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span><span class="w">       </span><span class="c1"># Additional parameters to send to login page</span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-My-Real-Port</span><span class="w"> </span><span class="nv">$remote_port</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-My-Server-Port</span><span class="w"> </span><span class="nv">$server_port</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>

<ul>
<li><code>proxy_pass</code> points to where the login script runs</li>
<li><code>proxy_set_header</code> can be used to pass additional fields that may
  be needed by the login script.  To implement for example,
  <code>$remote_addr</code> based access rules.</li>
</ul>
<p>So in this particular example, we are referring to a server with
<strong>TWO</strong> locations:</p>
<ol>
<li><code>http://auth-server.sample.com:8080/auth</code> - The sub-request URI which is not visible
   outside but handles the sub-request.</li>
<li><code>http://auth-server.sample.com:8080/login/</code> - The login URI which handles the
   login conversation.</li>
</ol>
<h2 id="the-authentication-server">The Authentication Server</h2>
<p>This is where the <a href="http://nginx.org/en/">nginx</a> documentation falls a bit short, there
is no actual authentication server example to refer to.</p>
<p>In my example, we have a simple authentication workflow.  When an
unauthenticated user hits the server, the sub-request is called
and checks (and fails) for a session cookie.</p>
<p>The user is then re-directed to the login page, where the actual
login takes place.  If succesful, a session cookie is set and
the user is redirected to the original URL.</p>
<p>This is implemented using the following script:</p>
<div class="highlight"><pre><span></span><code><span class="c1">#/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="n">SIGNATURE</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
<span class="n">COOKIE</span> <span class="o">=</span> <span class="s1">&#39;demo-cookie&#39;</span>

<span class="n">sessions</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">check_login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">True</span>
  <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">is_active_session</span><span class="p">():</span>
  <span class="n">sid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_cookie</span><span class="p">(</span><span class="n">COOKIE</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="n">SIGNATURE</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">sid</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span>
  <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">sid</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span>    

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/hello&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_headers</span><span class="p">():</span>
  <span class="n">hdrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
  <span class="kn">import</span> <span class="nn">pprint</span>
  <span class="k">return</span> <span class="s2">&quot;Got it</span><span class="se">\n</span><span class="s2">&lt;pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">hdrs</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/login/&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user_login</span><span class="p">():</span>
  <span class="n">sid</span> <span class="o">=</span> <span class="n">is_active_session</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">sid</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;Logged in as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sessions</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>

  <span class="k">return</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    &lt;form method=&quot;post&quot;&gt;</span>
<span class="s1">     Username: &lt;input name=&quot;username&quot; type=&quot;text&quot; /&gt;&lt;br/&gt;</span>
<span class="s1">     Password: &lt;input name=&quot;password&quot; type=&quot;password&quot; /&gt;&lt;br/&gt;</span>
<span class="s1">     &lt;input value=&quot;Login&quot; type=&quot;submit&quot; /&gt;</span>
<span class="s1">    &lt;/form&gt;&#39;&#39;&#39;</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/login/&#39;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">do_login</span><span class="p">():</span>
  <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
  <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="s1">&#39;url&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">url</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="k">if</span> <span class="n">check_login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span>
    <span class="n">sessions</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">COOKIE</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="n">SIGNATURE</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
      <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="s2">&quot;Welcome </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">username</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;Login Failed&quot;</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/auth&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">auth</span><span class="p">():</span>
  <span class="n">sid</span> <span class="o">=</span> <span class="n">is_active_session</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">sid</span><span class="p">:</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;X-Username&#39;</span><span class="p">,</span> <span class="n">sessions</span><span class="p">[</span><span class="n">sid</span><span class="p">])</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;X-Session&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sid</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;OK &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span><span class="s2">&quot;Unathenticated&quot;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
</code></pre></div>

<p><a href="https://github.com/alejandroliu/0ink.net/tree/master/snippets/nginx_mod_authrequest/auth1.py">nginx_mod_authrequest/auth1.py</a></p>
<p>This makes uses of the <a href="https://bottlepy.org/">bottle</a> micro framework.</p>
<p>It implements four routes:</p>
<ol>
<li><code>GET /hello</code>
   This is just a demo URL used for testing.  Only shows the request headers.</li>
<li><code>GET /login/</code>
   This is the login page entry point.</li>
<li><code>POST /login/</code>
   This is the handler for the login page.</li>
<li><code>GET /auth</code>
   This is the sub-request handler.</li>
</ol>
<p>For the demo, we are not really doing any login handling.  You only
need to make the username the same as the password to login.  Anything
else is a login failure.</p>
<p>When the user succesfully logs in, we set a cookie.  Because the
login URL and the protected resource (<code>/hello</code> URL) are in the
same cookie scope, we can use cookie set by the login page
as the verification token in the sub-request.</p>
<p>Note that the login page can be as simple or as complex as it is
needed.  For example, it is possible to implement a <a href="https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language">SAML</a>,
<a href="https://openid.net/connect/">OpenID Connect</a>, or any Single-Sign-On workflow
available.</p>
<p>Alternatively, two factor authentication could be implemented here.
The possibilities are endless.</p>
<p>An interesting use of the <a href="http://nginx.org/en/docs/http/ngx_http_auth_request_module.html">auth_request</a>
module would be to delegate <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">Basic Authentication</a> to a different
server or to even implement authentications not supported by
<a href="http://nginx.org/en/">nginx</a> like for example a simple Token-Bearer header or
<a href="https://en.wikipedia.org/wiki/Digest_access_authentication">Digest authentication</a></p>
<h3 id="basic-authentication">basic authentication</h3>
<p>This may seem silly since <a href="http://nginx.org/en/">nginx</a> supports <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">basic authentication</a>
out of the box.  The use case for this is when you have a cluster of nginx
front ends, and you want all of them to authenticate against a central
identity server.  Furthermore, since the URI can be passed, a more sophisticated
access control can be implemented.  Finally, additional values can be passed
through headers, such as group names, tokens, etc.</p>
<h4 id="nginx-configuration">nginx configuration</h4>
<p>Protected Resource:</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">location</span><span class="w"> </span><span class="s">/hello</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kn">auth_request</span><span class="w"> </span><span class="s">/auth</span><span class="p">;</span><span class="w">       </span><span class="c1"># The sub-request to use</span>
<span class="w">          </span><span class="kn">auth_request_set</span><span class="w"> </span><span class="nv">$username</span><span class="w"> </span><span class="nv">$upstream_http_x_username</span><span class="p">;</span><span class="w"> </span><span class="c1"># Make the sub request data available</span>

<span class="w">          </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://sample.com:8080/hello</span><span class="p">;</span><span class="w">  </span><span class="c1"># actual location of protected data</span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span><span class="w">  </span><span class="c1"># Custom headers with authentication related data</span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Remote-User</span><span class="w"> </span><span class="nv">$username</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>

<p><strong>NOTE:</strong> unlike the previous example, we do not need to provide a @error401 page.</p>
<p>Sub-request configuration:</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">location</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">/auth</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://auth-server.sample.com:8080/auth</span><span class="p">;</span><span class="w">   </span><span class="c1"># authentication server</span>
<span class="w">          </span><span class="kn">proxy_pass_request_body</span><span class="w"> </span><span class="no">off</span><span class="p">;</span><span class="w">              </span><span class="c1"># no data is being transferred...</span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Content-Length</span><span class="w"> </span><span class="s">&#39;0&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span><span class="w">              </span><span class="c1"># Custom headers with authentication related data</span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Origin-URI</span><span class="w"> </span><span class="nv">$request_uri</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>

<h4 id="authentication-server">authentication server</h4>
<p>The python implementation (again, using <a href="https://bottlepy.org/">bottle</a>):</p>
<div class="highlight"><pre><span></span><code><span class="c1">#/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="k">def</span> <span class="nf">check_login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">True</span>
  <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">authorize</span><span class="p">(</span><span class="n">basic_str</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">basic_str</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="n">auth</span> <span class="o">=</span> <span class="n">basic_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">auth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Basic&#39;</span><span class="p">:</span>
    <span class="c1"># We only support basic authentication</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="n">auth</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">auth</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="c1"># Unable to decode username password...</span>
    <span class="k">return</span> <span class="kc">False</span>

  <span class="k">if</span> <span class="n">check_login</span><span class="p">(</span><span class="n">auth</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">auth</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;X-Username&#39;</span><span class="p">,</span> <span class="n">auth</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="kc">True</span>

  <span class="k">return</span> <span class="kc">False</span>  


<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/hello&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_headers</span><span class="p">():</span>
  <span class="n">hdrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
  <span class="kn">import</span> <span class="nn">pprint</span>
  <span class="k">return</span> <span class="s2">&quot;Got it</span><span class="se">\n</span><span class="s2">&lt;pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">hdrs</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/auth&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">auth</span><span class="p">():</span>
  <span class="k">if</span> <span class="n">authorize</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">)):</span>
    <span class="k">return</span> <span class="s1">&#39;Yes, go in&#39;</span>

  <span class="n">response</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">,</span> <span class="s1">&#39;Basic realm=&quot;DEMO REALM&quot;&#39;</span><span class="p">)</span>
  <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">401</span>
  <span class="k">return</span> <span class="s1">&#39;Unauthenticated&#39;</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
</code></pre></div>

<p><a href="https://github.com/alejandroliu/0ink.net/tree/master/snippets/nginx_mod_authrequest/auth2.py">nginx_mod_authrequest/auth2.py</a></p>
<p>Like in the previous example, we are not doing any user/password verification.  We are only
checking if username and password are matching.</p>
<p>Unlike the previous example, all the authentication is handled by a single route (<code>/auth</code>).
It returns 'WWW-Authenticate' to prompt the user for a password.  And if it sees
an <code>Authorization</code> header, it would validate it.</p>
<h3 id="digest-authentication">digest authentication</h3>
<p>This implements <a href="https://en.wikipedia.org/wiki/Digest_access_authentication">digest</a> authentication for <a href="http://nginx.org/en/">nginx</a> using the
<a href="http://nginx.org/en/docs/http/ngx_http_auth_request_module.html">auth request module</a>.  The nginx configuration is the
same as in the <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">Basic</a> authentication.</p>
<p>The implentation in python (using <a href="https://bottlepy.org/">bottle</a> framework):</p>
<div class="highlight"><pre><span></span><code><span class="c1">#/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shlex</span>

<span class="n">REALM</span> <span class="o">=</span> <span class="s1">&#39;Demo Realm&#39;</span>

<span class="k">def</span> <span class="nf">md5sum</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">gen_noise</span><span class="p">(</span><span class="nb">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">):</span>
  <span class="n">letters</span> <span class="o">=</span> <span class="s1">&#39;0123456789abcdef&#39;</span>
  <span class="n">salt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">):</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">salt</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">salt</span>

<span class="k">def</span> <span class="nf">authorize</span><span class="p">(</span><span class="n">auth</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">auth</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="n">auth</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">auth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Digest&#39;</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">False</span>

  <span class="n">req</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">auth</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">:</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">continue</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">req</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">req</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

  <span class="c1"># make sure that all fields are there...</span>
  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">,</span><span class="s1">&#39;realm&#39;</span><span class="p">,</span><span class="s1">&#39;nonce&#39;</span><span class="p">,</span><span class="s1">&#39;uri&#39;</span><span class="p">,</span><span class="s1">&#39;response&#39;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing &quot;</span><span class="si">%s</span><span class="s1">&quot; in response&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

  <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-Origin-Method&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">method</span><span class="p">:</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>

  <span class="n">ha1</span> <span class="o">=</span> <span class="n">md5sum</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span><span class="n">req</span><span class="p">[</span><span class="s1">&#39;realm&#39;</span><span class="p">],</span><span class="n">req</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]))</span>
  <span class="n">ha2</span> <span class="o">=</span> <span class="n">md5sum</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">req</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]))</span>
  <span class="n">resp</span> <span class="o">=</span> <span class="n">md5sum</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ha1</span><span class="p">,</span> <span class="n">req</span><span class="p">[</span><span class="s1">&#39;nonce&#39;</span><span class="p">],</span> <span class="n">ha2</span><span class="p">))</span>

  <span class="c1">#print(req)</span>
  <span class="c1">#print(&quot;calc: %s\nrecv: %s\n&quot; % (resp, req[&#39;response&#39;]))</span>

  <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="n">req</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]:</span>  
    <span class="n">response</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;X-Username&#39;</span><span class="p">,</span> <span class="n">req</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="kc">True</span>

  <span class="k">return</span> <span class="kc">False</span>  


<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/hello&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_headers</span><span class="p">():</span>
  <span class="n">hdrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
  <span class="kn">import</span> <span class="nn">pprint</span>
  <span class="k">return</span> <span class="s2">&quot;Got it</span><span class="se">\n</span><span class="s2">&lt;pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">hdrs</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/auth&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">auth</span><span class="p">():</span>
  <span class="k">if</span> <span class="n">authorize</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">)):</span>
    <span class="k">return</span> <span class="s1">&#39;Yes, go in&#39;</span>

  <span class="n">nonce</span> <span class="o">=</span> <span class="n">gen_noise</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
  <span class="n">opaque</span> <span class="o">=</span> <span class="n">gen_noise</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

  <span class="c1">#print(&quot;nonce=%s\nopaque=%s\n&quot; % (nonce, opaque))</span>
  <span class="n">response</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">,</span> <span class="s1">&#39;Digest realm=&quot;</span><span class="si">%s</span><span class="s1">&quot;, nonce=&quot;</span><span class="si">%s</span><span class="s1">&quot;, opaque=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">REALM</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">opaque</span><span class="p">))</span>
  <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">401</span>
  <span class="k">return</span> <span class="s1">&#39;Unauthenticated&#39;</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
</code></pre></div>

<p><a href="https://github.com/alejandroliu/0ink.net/tree/master/snippets/nginx_mod_authrequest/auth3.py">nginx_mod_authrequest/auth3.py</a></p>
<hr>

	</article>


		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Years</h2>
	          <ul>
	              <li ><a href="/category/c2022.html">2022</a></li>
	              <li ><a href="/category/c2021.html">2021</a></li>
	              <li ><a href="/category/c2020.html">2020</a></li>
	              <li class="active"><a href="/category/c2019.html">2019</a></li>
	              <li ><a href="/category/c2018.html">2018</a></li>
	              <li ><a href="/category/c2017.html">2017</a></li>
	              <li ><a href="/category/c2016.html">2016</a></li>
	              <li ><a href="/category/c2015.html">2015</a></li>
	              <li ><a href="/category/c2014.html">2014</a></li>
	              <li ><a href="/category/c2013.html">2013</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="https://github.com/alejandroliu/">github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/alejandro-liu-ly/">LinkedIn</a><i></i></li>
			    </ul>
			  </aside>

	          <aside>
	            <h2>Links</h2>
	            <ul>
	                <li><a href="/sitemap.html">sitemap</a></li>
	                <li><a href="/tags.html">Tags</a></li>
	                <li><a href="https://github.com/alejandroliu/0ink.net">Repo</a></li>
	                <li><a href="https://home.0ink.net/nanowiki/">Wiki</a></li>
	            </ul>
	          </aside>
	      </div>

	  </div>

      <footer>

		<p role="contentinfo">
		  Â© 2021-2022 Alejandro Liu - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
		  <span class="feeds">
		    <a href="/feeds/rss.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="rss feed" title="rss feed"/></a>
		  </span>
		  </p>

	  </footer>

	</div>


</body>
</html>