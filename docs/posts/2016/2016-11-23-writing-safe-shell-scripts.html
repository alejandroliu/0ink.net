<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>Writing Safe Shell scripts - 0ink.net</title>
	<meta name="author" content="Alejandro Liu">


	<meta name="description" content="Writing shell scripts leaves a lot of room to make mistakes, in ways that will cause your scripts to break on certain input, or (if some input is untrusted) open up security vulnerabilities. Here are some tips on how to make your shell scripts safer. Don't The simplest step is …">
	<meta name="int-title" content="Writing Safe Shell scripts">
	<meta name="tags" content="configuration, directory, python, scripts, security, settings, tools">
	<meta name="date" content="2016-11-23 00:00:00+01:00">
	<meta name="modified" content="2021-12-25 22:02:18+01:00">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="/theme/css/main.css" type="text/css" />


    <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="0ink.net Atom Feed" />
    <link href="/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="0ink.net RSS Feed" />
</head>

<body>
    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	        <a href="/feeds/atom.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="atom feed" title="atom feed"/></a>
	    </div>
		<nav class="pages">
			    <a href="/pages/about.html">About</a>
-			    <a href="/pages/privacy-policy.html">Privacy Policy</a>
		</nav>
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		0ink.net</a>
	      <div class="logo">
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		  <img src="/images/2021/0ink.png" width="44" height="44" />
		</a>
	      </div>



      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
			<iframe src="https://duckduckgo.com/search.html?site=0ink.net&prefill=Search with DuckDuckGo" style="overflow:hidden;margin:5px;padding:0;width:408px;height:40px;" frameborder="0"></iframe>

	<article class="full">

		<h1>Writing Safe Shell scripts</h1>

<div class="metadata">
  <time datetime="2016-11-23T00:00:00+01:00" pubdate>Wed 23 November 2016</time>
    <address class="vcard author">
      by <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
    </address>
  <p>Updated: 2021-12-25 22:02:18+01:00</p>
  in <a href="/category/c2016.html">2016</a>
<p class="tags">tagged <a href="/tag/configuration.html">configuration</a>, <a href="/tag/directory.html">directory</a>, <a href="/tag/python.html">python</a>, <a href="/tag/scripts.html">scripts</a>, <a href="/tag/security.html">security</a>, <a href="/tag/settings.html">settings</a>, <a href="/tag/tools.html">tools</a></p></div>
		<p>Writing shell scripts leaves a lot of room to make mistakes, in ways that will cause
your scripts to break on certain input, or (if some input is untrusted) open up security
vulnerabilities. Here are some tips on how to make your shell scripts safer.</p>
<h2 id="dont">Don't</h2>
<p>The simplest step is to avoid using shell at all. Many higher-level languages are both
easier to write the code in in the first place, and avoid some of the issues that shell
has. For example, Python will automatically error out if you try to read from an
uninitialized variable (though not if you try to write to one), or if some function call
you make produces an error.</p>
<p>One of shell's chief advantages is that it's easy to call out to the huge variety of
command-line utilities available. Much of that functionality will be available through
libraries in Python or other languages. For the handful of things that aren't, you can
still call external programs. In Python, the
<a href="https://docs.python.org/2/library/subprocess.html">subprocess</a>
module is very useful for this.  You should try to avoid passing <code>shell=True</code> to <code>subprocess</code>
(or using <code>os.system</code> or similar functions at all), since that will run a shell, exposing
you to many of the same issues as plain shell has. It also has two big advantages over
shell: it's a lot easier to avoid
<a href="http://www.gnu.org/software/bash/manual/html_node/Word-Splitting.html">word-splitting</a>
or similar issues, and since calls to <code>subprocess</code> will tend to be relatively uncommon,
it's easy to scrutinize them especially hard. When using <code>subprocess</code> or similar tools,
you should still be aware of the suggestions in "Passing filenames or other positional
arguments to commands" below.</p>
<h2 id="shell-settings">Shell settings</h2>
<p>POSIX sh and especially bash have a number of settings that can help write safe shell
scripts.</p>
<p>I recommend the following in bash scripts:</p>
<div class="highlight"><pre><span></span><code><span class="nb">set</span> -euf -o pipefail
</code></pre></div>

<p>In dash, <code>set -o</code> doesn't exist, so use only <code>set -euf</code>.</p>
<p>What do those do?</p>
<p><a href="http://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html">set -e</a></p>
<p>If a command fails, <code>set -e</code> will make the whole script exit, instead of just resuming
on the next line. If you have commands that can fail without it being an issue, you can
append <code>|| true</code> or <code>|| :</code> to suppress this behavior - for example <code>set -e</code> followed by
<code>false || :</code> will not cause your script to terminate.</p>
<p><a href="http://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html">set -u</a></p>
<p>Treat unset variables as an error, and immediately exit.</p>
<p><a href="http://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html">set -f</a></p>
<p>Disable filename expansion (globbing) upon seeing <code>*</code>, <code>?</code>, etc..</p>
<p>If your script depends on globbing, you obviously shouldn't set this. Instead, you may find
<a href="http://www.gnu.org/software/bash/manual/html_node/The-Shopt-Builtin.html">shopt -s failglob</a>
useful, which causes globs that don't get expanded to cause errors, rather than getting
passed to the command with the <code>*</code> intact.</p>
<p><a href="http://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html">set -o pipefail</a></p>
<p><code>set -o pipefail</code> causes a pipeline (for example, <code>curl -s http://sipb.mit.edu/ | grep foo</code>) to produce a failure return code if any command errors. Normally, pipelines only return a failure if the last command errors. In combination with <code>set -e</code>, this will make your script exit if any command in a pipeline errors.</p>
<h2 id="quote-liberally">Quote liberally</h2>
<p>Whenever you pass a variable to a command, you should probably quote it. Otherwise, the shell
will perform
<a href="http://www.gnu.org/software/bash/manual/html_node/Word-Splitting.html">word-splitting</a> and
<a href="http://www.gnu.org/software/bash/manual/html_node/Filename-Expansion.html">globbing</a>,
which is likely not what you want.</p>
<p>For example, consider the following:</p>
<div class="highlight"><pre><span></span><code>alex@kronborg tmp <span class="o">[</span><span class="m">15</span>:23<span class="o">]</span> $ <span class="nv">dir</span><span class="o">=</span><span class="s2">&quot;foo bar&quot;</span>
alex@kronborg tmp <span class="o">[</span><span class="m">15</span>:23<span class="o">]</span> $ ls <span class="nv">$dir</span>
ls: cannot access foo: No such file or directory
ls: cannot access bar: No such file or directory
alex@kronborg tmp <span class="o">[</span><span class="m">15</span>:23<span class="o">]</span> $ <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$dir</span><span class="s2">&quot;</span>
alex@kronborg foo bar <span class="o">[</span><span class="m">15</span>:25<span class="o">]</span> $ <span class="nv">file</span><span class="o">=</span>*.txt
alex@kronborg foo bar <span class="o">[</span><span class="m">15</span>:26<span class="o">]</span> $ <span class="nb">echo</span> <span class="nv">$file</span>
bar.txt foo.txt
alex@kronborg foo bar <span class="o">[</span><span class="m">15</span>:26<span class="o">]</span> $ <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span>
*.txt
</code></pre></div>

<p>Depending on what you are doing in your script, it is likely that the word-splitting and
globbing shown above are not what you expected to have happen. By using <code>"$foo"</code> to access
the contents of the <code>foo</code> variable instead of just <code>$foo</code>, this problem does not arise.</p>
<p>When writing a wrapper script, you may wish pass along all the arguments your script
received. Do that with:</p>
<div class="highlight"><pre><span></span><code>wrapped-command <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</code></pre></div>

<p>See
<a href="http://www.gnu.org/software/bash/manual/html_node/Special-Parameters.html">"Special Parameters" in the bash manual</a>
for details on the distinction between <code>$*</code>, <code>$@</code>, and <code>"$@"</code> - the first and second are
rarely what you want in a safe shell script.</p>
<h2 id="passing-filenames-or-other-positional-arguments-to-commands">Passing filenames or other positional arguments to commands</h2>
<p>If you get filenames from the user or from shell globbing, or any other kind of
positional arguments, you should be aware that those could start with a <code>"-"</code>. Even if you
quote correctly, this may still act differently from what you intended. For example,
consider a script that allows somebody to run commands as <code>nobody</code> (exposed over <code>remctl</code>,
perhaps), consisting of just <code>sudo -u nobody "$@"</code>. The quoting is fine, but if a user
passes <code>-u root reboot</code>, <code>sudo</code> will catch the second <code>-u</code> and run it as <code>root</code>.</p>
<p>Fixing this depends on what command you're running.</p>
<p>For many commands, however, <code>--</code> is accepted to indicate that any options are done,
and future arguments should be parsed as positional parameters - even if they look like
options. In the <code>sudo</code> example above, <code>sudo -u nobody -- "$@"</code> would avoid this attack
(though obviously specifying in the <code>sudo</code> configuration that commands can only be run
as <code>nobody</code> is also a good idea).</p>
<p>Another approach is to prefix each filename with <code>./</code>, if the filenames are expected to be in the current directory.</p>
<h2 id="temporary-files">Temporary files</h2>
<p>A common convention to create temporary file names is to use <code>something.$$</code>.  This is not
safe.  It is better to use <code>mktemp</code>.</p>
<h2 id="other-resources">Other resources</h2>
<p>Google has a <a href="https://google.github.io/styleguide/shell.xml">Shell Style Guide</a>.
As the name suggests, it primarily focuses on good style, but some items are
safety/security-relevant.</p>
<h2 id="conclusion">Conclusion</h2>
<p>When possible, instead of writing a "safe" shell script, <strong>use a higher-level language
like Python</strong>. If you can't do that, the shell has several options that you can enable that
will reduce your chances of having bugs, and you should be sure to quote liberally.</p>
<p>Source <a href="https://sipb.mit.edu/doc/safe-shell/">Writing Safe Shell</a>.</p>

	</article>


		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Years</h2>
	          <ul>
	              <li ><a href="/category/c2022.html">2022</a></li>
	              <li ><a href="/category/c2021.html">2021</a></li>
	              <li ><a href="/category/c2020.html">2020</a></li>
	              <li ><a href="/category/c2019.html">2019</a></li>
	              <li ><a href="/category/c2018.html">2018</a></li>
	              <li ><a href="/category/c2017.html">2017</a></li>
	              <li class="active"><a href="/category/c2016.html">2016</a></li>
	              <li ><a href="/category/c2015.html">2015</a></li>
	              <li ><a href="/category/c2014.html">2014</a></li>
	              <li ><a href="/category/c2013.html">2013</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="https://github.com/alejandroliu/">github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/alejandro-liu-ly/">LinkedIn</a><i></i></li>
			    </ul>
			  </aside>

	          <aside>
	            <h2>Links</h2>
	            <ul>
	                <li><a href="/sitemap.html">sitemap</a></li>
	                <li><a href="/tags.html">Tags</a></li>
	                <li><a href="https://github.com/alejandroliu/0ink.net">Repo</a></li>
	                <li><a href="https://alejandro.iliu.net/">Alejandro</a></li>
	                <li><a href="https://home.0ink.net/nanowiki/">Wiki</a></li>
	            </ul>
	          </aside>
	      </div>

	  </div>

      <footer>

		<p role="contentinfo">
		  © 2021-2022 Alejandro Liu - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
		  <span class="feeds">
		    <a href="/feeds/rss.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="rss feed" title="rss feed"/></a>
		  </span>
		  </p>

	  </footer>

	</div>


</body>
</html>