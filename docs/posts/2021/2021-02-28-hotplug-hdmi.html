<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>Linux HDMI hotplug - 0ink.net</title>
	<meta name="author" content="Alejandro Liu">


	<meta name="description" content="The point of this article is to document I workaround that I came up with to handle a HDMI KVM switch. What happens is that if my Linux PC is turned on while the KVM switch is selecting the other PC, it fails to initialize the display, so when you …">
	<meta name="int-title" content="Linux HDMI hotplug">
	<meta name="tags" content="configuration, device, linux, windows">
	<meta name="date" content="2021-02-28 00:00:00+01:00">
	<meta name="modified" content="2021-12-26 20:53:13+01:00">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="/theme/css/main.css" type="text/css" />


    <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="0ink.net Atom Feed" />
    <link href="/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="0ink.net RSS Feed" />
</head>

<body>
    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	        <a href="/feeds/atom.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="atom feed" title="atom feed"/></a>
	    </div>
		<nav class="pages">
			    <a href="/pages/about.html">About</a>
-			    <a href="/pages/privacy-policy.html">Privacy Policy</a>
		</nav>
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		0ink.net</a>
	      <div class="logo">
		<a href="/" class="title"
 title="Not the site you are looking for..."		>
		  <img src="/images/2021/0ink.png" width="44" height="44" />
		</a>
	      </div>



      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
			<iframe src="https://duckduckgo.com/search.html?site=0ink.net&prefill=Search with DuckDuckGo" style="overflow:hidden;margin:5px;padding:0;width:408px;height:40px;" frameborder="0"></iframe>

	<article class="full">

		<h1>Linux HDMI hotplug</h1>

<div class="metadata">
  <time datetime="2021-02-28T00:00:00+01:00" pubdate>Sun 28 February 2021</time>
    <address class="vcard author">
      by <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
    </address>
  <p>Updated: 2021-12-26 20:53:13+01:00</p>
  in <a href="/category/c2021.html">2021</a>
<p class="tags">tagged <a href="/tag/configuration.html">configuration</a>, <a href="/tag/device.html">device</a>, <a href="/tag/linux.html">linux</a>, <a href="/tag/windows.html">windows</a></p></div>
		<p>The point of this article is to document I workaround that I came
up with to handle a HDMI KVM switch.</p>
<p>What happens is that if my Linux PC is turned on while the KVM switch
is selecting the other PC, it fails to initialize the display, so
when you switch back to the Linux PC, no display is shown.</p>
<p>The trick for this to work is to the use of <a href="https://wiki.debian.org/udev">udev</a> and <a href="https://xorg-team.pages.debian.net/xorg/howto/use-xrandr.html">xrandr</a>.</p>
<p>We use <a href="https://wiki.debian.org/udev">udev</a> to detect the monitor being plugged in, and we use
<a href="https://xorg-team.pages.debian.net/xorg/howto/use-xrandr.html">xrandr</a> to tell X windows to update the display.</p>
<h2 id="figuring-out-udev">Figuring out udev</h2>
<p>First in the agenda is to figure out what kind of event we should
be looking at.  For that, we use the command:</p>
<div class="highlight"><pre><span></span><code>udevadm monitor
</code></pre></div>

<p>With that we can determine what kind of <a href="https://wiki.debian.org/udev">udev</a> events to look
for (if any).</p>
<p>Next we need to figure out what keys we need to match.  Unfortunately
there is some guess work required as you need to figure out the <code>/dev</code>
device path, whereas <code>udevadm monitor</code> shows a <code>/devices/</code> path.</p>
<p>However, you manage, you need to use the following command:</p>
<div class="highlight"><pre><span></span><code>udevadm info --query=all --name=/dev/dri/card0 --attribute-walk
</code></pre></div>

<p>This will show possible attributes in the <a href="https://wiki.debian.org/udev">udev</a> rules key
format.</p>
<p>Once we know the keys to use, we can know create the rules files.</p>
<p>Rules are located in two locations:</p>
<ul>
<li><code>/usr/lib/udev/rules.d/</code> : for system default rules</li>
<li><code>/etc/udev/rules.d/</code> : for local specific rules</li>
</ul>
<p>Essentially, we are waiting for the monitor configuration to change
and when that happens we will run a script. This is accomplish with
the following rules file (99-xwin-hotplug.rules):</p>
<div class="highlight"><pre><span></span><code><span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;change&quot;</span>,<span class="w"> </span><span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;card*&quot;</span>,<span class="w"> </span><span class="nv">SUBSYSTEM</span><span class="o">==</span><span class="s2">&quot;drm&quot;</span>,<span class="w"> </span><span class="nv">RUN</span><span class="o">+=</span><span class="s2">&quot;/usr/local/bin/xwin-hotplug&quot;</span>
</code></pre></div>

<p>See: <a href="https://github.com/alejandroliu/0ink.net/tree/master/snippets/xwin-hotplug/99-xwin-hotplug.rules">hot-plug rules</a></p>
<h2 id="running-xrandr">Running xrandr</h2>
<p>The script that is kicked off by <a href="https://wiki.debian.org/udev">udev</a> does the following:</p>
<ol>
<li>Check if <code>Xorg</code> is running.</li>
<li>Assumes <code>DISPLAY</code> is <code>:0.0</code> (only one local display!) and tries to
   determine a suitable <code>XAUTHORITY</code> file.</li>
<li>Run <a href="https://xorg-team.pages.debian.net/xorg/howto/use-xrandr.html">xrandr</a> to try to determine what is the <code>connected</code>
   display.</li>
<li>Calls <code>xrandr --output "$monitor" --auto</code> to re-configure the display</li>
<li>Run <code>xrefresh</code> for good measure.</li>
</ol>
<p>See script:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1">#</span>
<span class="k">if</span><span class="w"> </span><span class="nv">xpid</span><span class="o">=</span><span class="k">$(</span>pidof<span class="w"> </span>Xorg<span class="k">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nv">DISPLAY</span><span class="o">=</span><span class="s2">&quot;:0.0&quot;</span>
<span class="w">  </span><span class="nv">XAUTHORITY</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">  </span><span class="nb">set</span><span class="w"> </span>-<span class="w"> </span><span class="k">$(</span>tr<span class="w"> </span><span class="s1">&#39;\0&#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span>&lt;/proc/<span class="nv">$xpid</span>/cmdline<span class="k">)</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span>
<span class="w">  </span><span class="k">do</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span>-auth<span class="o">)</span>
<span class="w">      </span><span class="nv">XAUTHORITY</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span>
<span class="w">      </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>
<span class="w">    </span><span class="nb">shift</span>
<span class="w">  </span><span class="k">done</span>
<span class="w">  </span><span class="nb">export</span><span class="w"> </span>DISPLAY<span class="w"> </span>XAUTHORITY
<span class="w">  </span><span class="nv">output</span><span class="o">=</span><span class="k">$(</span>xrandr<span class="k">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="nv">port</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$output</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;$2 == &quot;connected&quot; { print $1 }&#39;</span><span class="k">)</span>
<span class="w">  </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$port</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span>xrandr<span class="w"> </span>--output<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$port</span><span class="s2">&quot;</span><span class="w"> </span>--auto
<span class="w">  </span>sleep<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>xrefresh
<span class="k">fi</span>
</code></pre></div>

<p>See: <a href="https://github.com/alejandroliu/0ink.net/tree/master/snippets/xwin-hotplug/xwin-hotplug/xwin-hotplug">hot-plug script</a></p>
<h2 id="see-also">See Also</h2>
<ul>
<li><a href="https://www.thegeekdiary.com/beginners-guide-to-udev-in-linux/">Beginners guide to udev</a></li>
<li><a href="https://linuxconfig.org/tutorial-on-how-to-write-basic-udev-rules-in-linux">Tutorial on how to write basic udev rules</a></li>
<li><a href="https://opensource.com/article/18/11/udev">Intro to udev</a></li>
</ul>

	</article>


		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Years</h2>
	          <ul>
	              <li ><a href="/category/c2023.html">2023</a></li>
	              <li ><a href="/category/c2022.html">2022</a></li>
	              <li class="active"><a href="/category/c2021.html">2021</a></li>
	              <li ><a href="/category/c2020.html">2020</a></li>
	              <li ><a href="/category/c2019.html">2019</a></li>
	              <li ><a href="/category/c2018.html">2018</a></li>
	              <li ><a href="/category/c2017.html">2017</a></li>
	              <li ><a href="/category/c2016.html">2016</a></li>
	              <li ><a href="/category/c2015.html">2015</a></li>
	              <li ><a href="/category/c2014.html">2014</a></li>
	              <li ><a href="/category/c2013.html">2013</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="https://github.com/alejandroliu/">github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/alejandro-liu-ly/">LinkedIn</a><i></i></li>
			    </ul>
			  </aside>

	          <aside>
	            <h2>Links</h2>
	            <ul>
	                <li><a href="/sitemap.html">sitemap</a></li>
	                <li><a href="/tags.html">Tags</a></li>
	                <li><a href="https://github.com/alejandroliu/0ink.net">Repo</a></li>
	                <li><a href="https://home.0ink.net/nanowiki/">Wiki</a></li>
	            </ul>
	          </aside>
	      </div>

	  </div>

      <footer>

		<p role="contentinfo">
		  © 2021-2022 Alejandro Liu - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey">pelican-simplegrey</a>.
		  <span class="feeds">
		    <a href="/feeds/rss.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="rss feed" title="rss feed"/></a>
		  </span>
		  </p>

	  </footer>

	</div>


</body>
</html>