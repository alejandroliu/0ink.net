<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>Automatically adding systems to an AD domain</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="When using virtualisation it is very common to create template VMs that can be cloned from. This makes deployment much easier than having to..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">0ink.net</a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">About</a></li>
                    <li><a href="/pages/privacy-policy.html">Privacy Policy</a></li>
                    <li class="active"><a href="/category/blog.html">Blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/automatically-adding-systems-to-an-ad-domain.html" rel="bookmark"
           title="Permalink to Automatically adding systems to an AD domain">Automatically adding systems to an AD domain</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-05-19T00:00:00+02:00">
                Published: Sun 19 May 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/alejandro-liu.html">Alejandro Liu</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>

</footer><!-- /.post-info -->      <p>When using virtualisation it is very common to create <em>template</em> VMs
that can be cloned from. This makes deployment much easier than having
to install a new VM from scratch. Unfortunately, the cloned VMs lack
any Active Directory memberships and the VMs have to be <em>manually</em>
added to the AD domain. For automated deployment scenarios this is
less than desirable. This recipe intends to solve that issue in a
<em>Hypervisor</em> independant manner. This recipe uses a Visual Basic
script that will automatically join a system to a domain during
Windows system preparation. In Lab Manager these steps can be
performed on a VM Template so that virtual machines cloned from it
will be joined to the domain when the system customization process
runs. A specific Active Directory Organizational Unit can be
specified. The Visual Basic script will contain credentials used for
joining the system to the domain. So, as a security measure the Visual
Basic script is setup to be deleted at the end of a successful
execution.</p>
<h2>Prerequisites</h2>
<ul>
<li>Active Directory User Account with permissions to add Computer Objects.</li>
<li>LDAP path syntax to Active Directory Organizational Unit to add the Computer to.</li>
</ul>
<h2>Steps on the VM Template</h2>
<h3>Create Scripts Folder</h3>
<p><code>C:\Windows\Setup\Scripts</code></p>
<h3>Create Batch File</h3>
<p><code>C:\Windows\Setup\SetupComplete.cmd</code></p>
<div class="highlight"><pre><span></span><code><span class="nv">Start</span> <span class="o">/</span><span class="k">wait</span> <span class="nv">cscript</span> <span class="o">%</span><span class="nv">WINDIR</span><span class="o">%</span>\<span class="nv">Setup</span>\<span class="nv">Scripts</span>\<span class="nv">AddDomain</span>.<span class="nv">vbs</span>
<span class="nv">Del</span> <span class="o">%</span><span class="nv">WINDIR</span><span class="o">%</span>\<span class="nv">Setup</span>\<span class="nv">Scripts</span>\<span class="nv">AddDomain</span>.<span class="nv">vbs</span>
</code></pre></div>

<h3>Create VBS File</h3>
<p><code>C:\Windows\Setup\Scripts\AddDomain.vbs</code></p>
<div class="highlight"><pre><span></span><code>Const JOIN_DOMAIN             = 1
Const ACCT_CREATE             = 2
Const ACCT_DELETE             = 4
Const WIN9X_UPGRADE           = 16
Const DOMAIN_JOIN_IF_JOINED   = 32
Const JOIN_UNSECURE           = 64
Const MACHINE_PASSWORD_PASSED = 128
Const DEFERRED_SPN_SET        = 256
Const INSTALL_INVOCATION      = 262144

strDomain   = &quot;DomainName&quot;
strOU       = &quot;LDAP\OU\PATH&quot;
strUser     = &quot;Domain\Username&quot;
strPassword = &quot;Password&quot;

Set objNetwork = CreateObject(&quot;WScript.Network&quot;)
strComputer = objNetwork.ComputerName

Set objComputer = _
  GetObject(&quot;winmgmts:{impersonationLevel=Impersonate}!&quot; &amp; _
  strComputer &amp; &quot;rootcimv2:Win32_ComputerSystem.Name=&#39;&quot; _
  &amp; strComputer &amp; &quot;&#39;&quot;)

ReturnValue = objComputer.JoinDomainOrWorkGroup(strDomain, _
   strPassword, _
   strDomain &amp; &quot;\&quot; &amp; strUser, _
   strOU, _
   JOIN_DOMAIN + ACCT_CREATE)
</code></pre></div>

<p>Tip: Start Notepad as administrator to have save access to the folder.
Set the correct values for <code>StrDomain</code>, <code>StrOU</code>, <code>StrUser</code> and <code>StrPassword</code>
Example:</p>
<div class="highlight"><pre><span></span><code>    strDomain = &quot;best.adinternal.com&quot; 
    strOU = &quot;ou=Virtuals,ou=CRE R&amp;D,ou=Beaverton,ou=Shared Management,dc=best,dc=adinternal,dc=com&quot; 
    strUser&amp; = &quot;_adjoinuser&quot; 
    strPassword = &quot;$uperS3curePassw()rd!{13245}&quot; 
</code></pre></div>

<h2>Deploy VM</h2>
<p>Be sure <code>Perform customization</code> is checked and <code>Microsoft Sysprep</code> is
selected on the VM Template properties. <code>Clone the VM Template</code></p>
<p>Tip: Wait around 10 minutes before trying to login to the VM. During
this time the VM is going through the sysprep process which will change
the hostname to the name specified when cloning the VM to a
configuration and join the domain. The process should be complete when
the login screen displays <strong>[Ctrl]+[Alt]+[Delete]</strong> and prompts
for a domain login.</p>
<h2>Additional notes</h2>
<p>To improve security we could for example not hardcode login credentials
in the VB script. Instead, we could retrieve them from a web server
(using SSL). This server could reset the Login password for the
addDomain account and send that. Once this is completed, the password
could be reset again. Also, the web server could check the IP address
and referencing DNS/DHCP to see if this machine is indeed being
authorised. Finally, we can place this in a different AD domain (with
the appropriate trust relationships) so that you can apply additional
security policies.</p>
<h2>References</h2>
<ul>
<li>This recipe was originally published at: <a href="http://www.bonusbits.com/main/HowTo:Setup_a_VM_to_Automatically_Join_to_a_Domain">http://www.bonusbits.com/main/HowTo:Setup_a_VM_to_Automatically_Join_to_a_Domain</a><br>
    Unfortunately I am no longer able to reach this site.</li>
<li><a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1007491">http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1007491</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa392154%28v=vs.85%29.aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/aa392154%28v=vs.85%29.aspx</a></li>
</ul>
<p>Other examples:</p>
<ul>
<li><a href="http://mail-archives.apache.org/mod_mbox/incubator-vcl-user/201112.mbox/%3CCAD7o_XxD2a9j0+V7faE1nTSt-OMT+W9=y4TCvKZ-3q92+czewQ@mail.gmail.com%3E">http://mail-archives.apache.org/mod_mbox/incubator-vcl-user/201112.mbox/%3CCAD7o_XxD2a9j0+V7faE1nTSt-OMT+W9=y4TCvKZ-3q92+czewQ@mail.gmail.com%3E</a></li>
<li><a href="http://www.virtualizationteam.com/virtualization-vmware/vcloud-director/vcloud-director-joining-vms-to-specific-active-directory-domain-ou.html">http://www.virtualizationteam.com/virtualization-vmware/vcloud-director/vcloud-director-joining-vms-to-specific-active-directory-domain-ou.html</a></li>
<li><a href="http://itnervecenter.com/content/deploying-window-server-2008-r2-vmware-template-and-joining-it-domain">http://itnervecenter.com/content/deploying-window-server-2008-r2-vmware-template-and-joining-it-domain</a></li>
<li><a href="http://blogs.citrix.com/2011/09/16/xenclient-auto-join-vms-to-the-activedirectory/">http://blogs.citrix.com/2011/09/16/xenclient-auto-join-vms-to-the-activedirectory/</a></li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://www.iliu.net">Familia</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://github.com/alejandroliu/0ink.net">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>